<!DOCTYPE html>
<html lang="it">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <title>Corner ‚Äì Back Office</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <style>
        body {
            padding: 15px;
        }
        body { background-color: #f8f9fa; }
        .container { margin-top: 40px; }
        .hidden { display: none; }
        img.thumb { max-width: 80px; height: auto; border-radius: 6px; }
        .btn-switch { margin-right: 10px; }
        td input, td select { width: 100%; }
        /* Migliora margini e padding delle sezioni */
        .container {
            margin-top: 40px;
            margin-bottom: 60px;
        }

        /* Uniforma lo stile delle tabelle menu */
        #menuTablesContainer .table {
            background-color: #fff;
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }

        /* Stile celle */
        #menuTablesContainer th,
        #menuTablesContainer td {
            vertical-align: middle;
            text-align: center;
            padding: 12px;
        }

        /* Migliora il layout dei titoli delle categorie */
        #menuTablesContainer h5 {
            margin-bottom: 20px;
            margin-top: 40px;
            padding-left: 10px;
            font-weight: bold;
            border-left: 4px solid #007bff;
            color: #333;
        }
        @media (max-width: 768px) {
            h5 {
                font-size: 1rem;
            }

            .btn-switch {
                margin-bottom: 8px;
                width: 100%;
            }

            .form-row {
                display: block;
            }

            .form-group {
                width: 100% !important;
                margin-bottom: 15px;
            }

            .table th,
            .table td {
                font-size: 14px;
                padding: 8px;
            }

            .thumb {
                width: 60px;
            }

            .container {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <h2 class="text-center mb-4">üìã Back Office ‚Äì Corner</h2>

    <div class="mb-4 text-center">
        <button class="btn btn-outline-primary btn-switch" onclick="showSection('prenotazioni')">Prenotazioni</button>
        <button class="btn btn-outline-secondary btn-switch" onclick="showSection('menu')">Modifica Menu</button>
        <button class="btn btn-outline-success btn-switch" onclick="showSection('evidenza')">Contenuti in Evidenza</button>
        <button class="btn btn-outline-danger btn-switch" onclick="showSection('promozioni')">Promozioni</button>
        <button class="btn btn-outline-dark btn-switch" onclick="showSection('utenti')">Utenti</button>

    </div>

    <!-- Sezione Prenotazioni -->
    <div id="sectionPrenotazioni" class="hidden">
        <div id="reservationsByDateContainer"></div>
    </div>

    <!-- Sezione Menu -->
    <div id="sectionMenu" class="hidden">
        <h5 class="mb-3">‚ûï Aggiungi nuovo piatto</h5>
        <form id="formAddNewItem">
            <div class="form-row">
                <div class="form-group col-md-3">
                    <input type="text" name="titolo" class="form-control" placeholder="Titolo" required />
                </div>
                <div class="form-group col-md-2">
                    <select name="categoria" class="form-control" id="categoriaSelectMenu" required>
                        <option value="">Seleziona Categoria</option>
                    </select>
                </div>
                <div class="form-group col-md-3">
                    <input type="text" name="descrizione" class="form-control" placeholder="Descrizione" />
                </div>
                <div class="form-group col-md-2">
                    <input type="number" step="0.01" name="prezzo" class="form-control" placeholder="Prezzo (‚Ç¨)" required />
                </div>
                <div class="form-group col-md-2">
                    <input type="file" name="image" accept="image/*" class="form-control-file" required />
                </div>
            </div>
            <div class="form-group col-md-2">
                <label>Visibile:</label>
                <select name="visibile" class="form-control">
                    <option value="true">‚úÖ S√¨</option>
                    <option value="false">‚ùå No</option>
                </select>
            </div>
            <button type="submit" class="btn btn-success">Salva Piatto</button>
        </form>

        <hr class="my-4" />

        <h4 class="mb-3">üçî Menu Attuale</h4>
        <div id="menuTablesContainer"></div>
    </div>

    <!-- Sezione Evidenza -->
    <div id="sectionEvidenza" class="hidden">
        <h5 class="mb-3">‚≠ê Aggiungi Contenuto in Evidenza</h5>
        <form id="formAddHighlight">
            <div class="form-row">
                <div class="form-group col-md-4">
                    <select id="categoriaSelectEvidenza" class="form-control" required>
                        <option value="">Seleziona Categoria</option>
                    </select>
                </div>
                <div class="form-group col-md-4">
                    <select id="prodottoSelectEvidenza" class="form-control" disabled required>
                        <option value="">Seleziona Prodotto</option>
                    </select>
                </div>
                <div class="form-group col-md-2">
                    <button type="submit" class="btn btn-success">Aggiungi</button>
                </div>
            </div>
        </form>

        <hr class="my-4" />

        <h4 class="mb-3">üìå Contenuti in Evidenza</h4>
        <div id="highlightsContainer"></div>
    </div>
</div>

<!-- Sezione Promozioni -->
<div id="sectionPromozioni" class="hidden">
    <h5 class="mb-3">üéØ Crea Promozione</h5>
    <form id="formAddPromozione">
        <div class="form-row">
            <div class="form-group col-md-4">
                <input type="text" class="form-control" name="nome" placeholder="Nome Promozione" required>
            </div>
            <div class="form-group col-md-12">
                <textarea name="descrizione" class="form-control" placeholder="Descrizione promozione" rows="2"></textarea>
            </div>
            <div class="form-group col-md-4">
                <label>Data Inizio:</label>
                <input type="date" name="dataInizio" class="form-control" required />
            </div>
            <div class="form-group col-md-4">
                <label>Data Fine:</label>
                <input type="date" name="dataFine" class="form-control" required />
            </div>

            <div class="form-group col-md-2">
                <input type="number" step="1" min="1" max="100" name="sconto" class="form-control" placeholder="% Sconto" required>
            </div>
            <div class="form-group col-md-12">
                <label>Prodotti da includere:</label>
                <div id="checklistProdottiPromozione" class="row"></div>
            </div>
        </div>
        <div class="col-md-12 mt-3">
            <div class="alert alert-info" id="selectedPromoSummary" style="display: none;"></div>
        </div>
        <button type="submit" class="btn btn-danger">Crea Promozione</button>
    </form>
    <h4 class="mb-3">üìú Tutte le Promozioni</h4>
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="thead-dark">
            <tr>
                <th>Nome</th>
                <th>Descrizione</th>
                <th>Prezzo Totale</th>
                <th>Attiva</th>
            </tr>
            </thead>
            <tbody id="promozioniTableBody"></tbody>
        </table>
    </div>


</div>

<div id="sectionUtenti" class="hidden">
    <h5 class="mb-3">üë• Lista Utenti</h5>
    <div class="table-responsive">
        <table class="table table-bordered table-hover">
            <thead class="thead-dark">
            <tr><th>ID</th><th>Nome</th><th>Telefono</th><th>Azioni</th></tr>
            </thead>
            <tbody id="utentiTableBody"></tbody>
        </table>
    </div>
</div>

<script>
    function showSection(section) {
        ['prenotazioni','menu','evidenza','promozioni'].forEach(s => {
            document.getElementById('section' + capitalize(s)).classList.add('hidden');
        });
        if (section === 'prenotazioni') {
            document.getElementById('sectionPrenotazioni').classList.remove('hidden');
            loadReservations();
        } else if (section === 'menu') {
            document.getElementById('sectionMenu').classList.remove('hidden');
            loadMenuItems();
        } else if (section === 'evidenza') {
            document.getElementById('sectionEvidenza').classList.remove('hidden');
            loadInEvidenza();
        } else if (section === 'promozioni') {
            document.getElementById('sectionPromozioni').classList.remove('hidden');
            loadPromozioni();
        } else if (section === 'utenti') {
            document.getElementById('sectionUtenti').classList.remove('hidden');
            loadUtenti();
        }


    }

    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    // Prenotazioni
    async function loadReservations() {
        const res = await fetch('/admin/reservations');
        const data = await res.json();
        const grouped = {};
        data.forEach(r => {
            if (!grouped[r.date]) grouped[r.date] = [];
            grouped[r.date].push(r);
        });
        const container = document.getElementById('reservationsByDateContainer');
        container.innerHTML = '';
        Object.keys(grouped).sort().forEach(date => {
            const section = document.createElement('div');
            section.classList.add('mb-5');
            const rows = grouped[date].map(r => `
                <tr>
                  <td>${r.name}</td>
                  <td>${r.phone}</td>
                  <td>${r.time}</td>
                  <td>${r.people}</td>
                  <td>${r.note || ''}</td>
                  <td><button class="btn btn-danger btn-sm" onclick="deleteReservation(${r.id})">Elimina</button></td>
                </tr>
            `).join('');
            section.innerHTML = `
                <h5>üìÖ ${formatDate(date)}</h5>
                <table class="table table-bordered table-hover">
                  <thead class="thead-dark">
                    <tr><th>Nome</th><th>Telefono</th><th>Ora</th><th>Persone</th><th>Note</th><th>Azioni</th></tr>
                  </thead>
                  <tbody>${rows}</tbody>
                </table>
            `;
            container.appendChild(section);
        });
    }
    async function deleteReservation(id) {
        if (!confirm('Vuoi davvero eliminare questa prenotazione?')) return;
        const res = await fetch(`/admin/reservations/${id}`, { method: 'DELETE' });
        if (res.ok) loadReservations(); else alert('Errore durante l\'eliminazione.');
    }
    function formatDate(dateStr) {
        const d = new Date(dateStr);
        return d.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Menu
    async function loadMenuItems() {
        const res = await fetch('/admin/menu');
        const data = await res.json();
        const grouped = {};
        data.forEach(item => {
            if (!grouped[item.categoria]) grouped[item.categoria] = [];
            grouped[item.categoria].push(item);
        });
        populateSelect('Menu', Object.keys(grouped));
        const container = document.getElementById('menuTablesContainer');
        container.innerHTML = '';
        Object.keys(grouped).sort().forEach(cat => {
            const section = document.createElement('div');
            section.classList.add('mb-5');
            const rows = grouped[cat].map(item => {
                const imgSrc = item.imageUrl && item.imageUrl.trim() !== '' ? item.imageUrl :
                    `https://res.cloudinary.com/dytvizqtq/image/upload/prodotti/${item.id}.png`;
                return `
                    <tr id="menu-row-${item.id}">
                      <td><img src="${imgSrc}" onerror="this.onerror=null;this.src='/img/placeholder.png'" class="thumb" /></td>
                      <td>${escape(item.titolo)}</td>
                      <td>${escape(item.descrizione || '')}</td>
                      <td>‚Ç¨${item.prezzo.toFixed(2)}</td>
                      <td><button class="btn btn-sm btn-outline-${item.visibile ? 'success' : 'secondary'}" onclick="toggleVisibility(${item.id})">${item.visibile ? '‚úÖ' : '‚ùå'}</button></td>
                      <td>
                        <button class="btn btn-sm btn-warning" onclick="makeEditable(${item.id}, '${escape(item.titolo)}', '${escape(item.categoria)}', '${escape(item.descrizione || '')}', ${item.prezzo})">Modifica</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteMenuItem(${item.id})">Elimina</button>
                      </td>
                    </tr>
                `;
            }).join('');
            section.innerHTML = `
                <h5>üçΩÔ∏è Categoria: <strong>${escape(cat)}</strong></h5>
                <div class="table-responsive">
                  <table class="table table-bordered table-hover">
                    <thead class="thead-dark">
                      <tr><th>Foto</th><th>Titolo</th><th>Descrizione</th><th>Prezzo</th><th>Visibile</th><th>Azioni</th></tr>
                    </thead>
                    <tbody>${rows}</tbody>
                  </table>
                </div>
            `;
            container.appendChild(section);
        });
    }
    document.getElementById('formAddNewItem').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const data = {
            titolo: form.titolo.value,
            categoria: form.categoria.value,
            descrizione: form.descrizione.value,
            prezzo: parseFloat(form.prezzo.value),
            visibile: form.visibile.value === 'true'
        };
        const formData = new FormData();
        formData.append('data', new Blob([JSON.stringify(data)], { type: 'application/json' }));
        if (form.image.files[0]) formData.append('image', form.image.files[0]);
        const res = await fetch('/admin/menu', { method: 'POST', body: formData });
        if (res.ok) { alert('‚úÖ Piatto aggiunto!'); form.reset(); loadMenuItems(); }
        else alert('‚ùå Errore nell\'aggiunta');
    });
    async function toggleVisibility(id) { await fetch(`/admin/menu/${id}/toggle`, { method: 'PATCH' }); loadMenuItems(); }
    async function deleteMenuItem(id) { if (!confirm('Eliminare questo piatto?')) return; await fetch(`/admin/menu/${id}`, { method: 'DELETE' }); loadMenuItems(); }
    function makeEditable(id, titolo, categoria, descrizione, prezzo) {
        const row = document.getElementById(`menu-row-${id}`);
        row.innerHTML = `
          <td><input type="file" id="edit-image-${id}" accept="image/*" /></td>
          <td><input type="text" id="edit-titolo-${id}" value="${titolo}" /></td>
          <td><input type="text" id="edit-desc-${id}" value="${descrizione}" /></td>
          <td><input type="number" id="edit-prezzo-${id}" value="${prezzo}" step="0.01" /></td>
          <td><input type="text" id="edit-cat-${id}" value="${categoria}" /></td>
          <td>
            <button class="btn btn-sm btn-success" onclick="submitEdit(${id})">Salva</button>
            <button class="btn btn-sm btn-secondary" onclick="loadMenuItems()">Annulla</button>
          </td>
        `;
    }
    async function submitEdit(id) {
        const titolo = document.getElementById(`edit-titolo-${id}`).value;
        const descrizione = document.getElementById(`edit-desc-${id}`).value;
        const prezzo = parseFloat(document.getElementById(`edit-prezzo-${id}`).value);
        const categoria = document.getElementById(`edit-cat-${id}`).value;
        const imageInput = document.getElementById(`edit-image-${id}`);
        const data = { titolo, descrizione, prezzo, categoria };
        const formData = new FormData();
        formData.append('data', new Blob([JSON.stringify(data)], { type: 'application/json' }));
        if (imageInput.files.length > 0) formData.append('image', imageInput.files[0]);
        await fetch(`/admin/menu/${id}`, { method: 'PUT', body: formData });
        loadMenuItems();
    }

    // Evidenza
    async function loadInEvidenza() {
        // Recupera piatti e contenuti in evidenza
        const [menuRes, evidenzaRes] = await Promise.all([
            fetch('/admin/menu'),
            fetch('/admin/in_evidenza')
        ]);
        const menuData = await menuRes.json();
        const evidenzaData = await evidenzaRes.json();

        // Mappa ID piatto -> Titolo
        const idToTitolo = {};
        menuData.forEach(item => {
            idToTitolo[item.id] = item.titolo;
        });

        // Popola categorie
        const categories = [...new Set(menuData.map(i => i.categoria))].sort();
        populateSelect('Evidenza', categories);

        // Contenitore HTML
        const container = document.getElementById('highlightsContainer');
        container.innerHTML = '';
        if (evidenzaData.length === 0) {
            container.innerHTML = '<p>Nessun contenuto in evidenza.</p>';
            return;
        }

        // Renderizza
        evidenzaData.forEach(h => {
            const itemId = h.itemId || h.item_id;
            const titolo = idToTitolo[itemId] || 'Titolo non disponibile';
            const div = document.createElement('div');
            div.classList.add('mb-2');
            div.innerHTML = `
            <span>‚≠ê [${h.categoria}] ${titolo}</span>
            <button class="btn btn-sm btn-danger ml-2" onclick="deleteInEvidenza(${h.id})">Rimuovi</button>
        `;
            container.appendChild(div);
        });
    }
    document.getElementById('categoriaSelectEvidenza').addEventListener('change', async e => {
        const cat = e.target.value;
        const prodSelect = document.getElementById('prodottoSelectEvidenza');
        prodSelect.innerHTML = '<option value="">Seleziona Prodotto</option>';
        if (!cat) { prodSelect.disabled = true; return; }
        const res = await fetch('/admin/menu');
        const items = (await res.json()).filter(i => i.categoria === cat);
        items.forEach(i => {
            const opt = document.createElement('option'); opt.value = i.id; opt.textContent = i.titolo;
            prodSelect.appendChild(opt);
        });
        prodSelect.disabled = false;
    });
    document.getElementById('formAddHighlight').addEventListener('submit', async e => {
        e.preventDefault();
        const cat = document.getElementById('categoriaSelectEvidenza').value;
        const prodId = document.getElementById('prodottoSelectEvidenza').value;
        if (!cat || !prodId) return alert('Seleziona categoria e prodotto.');
        const res = await fetch('/admin/in_evidenza', {
            method: 'POST', headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ categoria: cat, itemId: prodId })
        });
        if (res.ok) { loadInEvidenza(); e.target.reset(); document.getElementById('prodottoSelectEvidenza').disabled = true; }
        else alert('Errore nell\'aggiunta del contenuto in evidenza.');
    });
    async function deleteInEvidenza(id) {
        if (!confirm('Rimuovere questo contenuto in evidenza?')) return;
        const res = await fetch(`/admin/in_evidenza/${id}`, { method: 'DELETE' });
        if (res.ok) loadInEvidenza(); else alert('Errore durante la rimozione.');
    }

    // Utility
    function populateSelect(context, categories) {
        const select = document.getElementById(`categoriaSelect${context}`);
        select.innerHTML = '<option value="">Seleziona Categoria</option>';
        categories.forEach(cat => {
            const opt = document.createElement('option'); opt.value = cat; opt.textContent = cat;
            select.appendChild(opt);
        });
    }
    function escape(str) {
        return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }
    document.addEventListener('DOMContentLoaded', () => { showSection('prenotazioni'); });
    document.getElementById('formAddPromozione').addEventListener('submit', async e => {
        e.preventDefault();
        const nome = e.target.nome.value;
        const sconto = parseFloat(e.target.sconto.value);
        const descrizione = e.target.descrizione.value;
        const dataInizio = e.target.dataInizio.value;
        const dataFine = e.target.dataFine.value;
        const selectedCheckboxes = Array.from(document.querySelectorAll('#checklistProdottiPromozione input[type="checkbox"]:checked'));
        if (selectedCheckboxes.length === 0) return alert("Seleziona almeno un prodotto!");
        const items = selectedCheckboxes.map(cb => ({
            menuItemId: parseInt(cb.value),
            scontoPercentuale: sconto
        }));
        const payload = {
            nome,
            descrizione,
            dataInizio,
            dataFine,
            attiva: true,
            items
        };
        const res = await fetch('/admin/promotions', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });
        if (res.ok) {
            alert("‚úÖ Promozione creata!");
            e.target.reset();
            loadPromozioni();
        } else {
            alert("‚ùå Errore nella creazione.");
        }
    });

    // PROMOZIONI
    async function loadPromozioni() {
        const [menuRes, promoRes] = await Promise.all([
            fetch('/admin/menu'),
            fetch('/admin/promotions')
        ]);
        const menuData = await menuRes.json();
        const promoData = await promoRes.json();

        // Organizza i piatti per categoria (per la checklist creazione promo)
        const grouped = {};
        menuData.forEach(item => {
            if (!grouped[item.categoria]) grouped[item.categoria] = [];
            grouped[item.categoria].push(item);
        });

        const checklist = document.getElementById('checklistProdottiPromozione');
        checklist.innerHTML = '';
        Object.keys(grouped).sort().forEach(categoria => {
            const section = document.createElement('div');
            section.classList.add('col-md-12', 'mb-3');

            let rows = grouped[categoria].map(item => `
    <tr>
      <td><input class="form-check-input promo-checkbox" type="checkbox" value="${item.id}" data-title="${item.titolo}"></td>
      <td>${item.titolo}</td>
      <td>‚Ç¨${item.prezzo.toFixed(2)}</td>
    </tr>
  `).join('');

            section.innerHTML = `
    <h6><strong>${categoria}</strong></h6>
    <div class="table-responsive">
      <table class="table table-bordered table-sm">
        <thead><tr><th>‚úì</th><th>Prodotto</th><th>Prezzo</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    </div>
  `;
            checklist.appendChild(section);
        });

        // Tabella promozioni (stile tabellare come richiesto)
        const promozioniTableBody = document.getElementById('promozioniTableBody');
        promozioniTableBody.innerHTML = '';
        promoData
            .sort((a, b) => new Date(a.dataInizio) - new Date(b.dataInizio))
            .forEach(promo => {
                // Calcola prezzo totale e scontato
                let prezzoTotale = 0;
                let prezzoScontato = 0;
                let descrizioneEstesa = '';
                if (promo.items && promo.items.length > 0) {
                    descrizioneEstesa = '<ul style="margin-bottom:0">';
                    promo.items.forEach(el => {
                        const prodotto = menuData.find(m => m.id === el.menuItem.id);
                        if (!prodotto) return;
                        const sconto = el.scontoPercentuale;
                        const originale = prodotto.prezzo;
                        const scontato = originale * (1 - sconto / 100);
                        prezzoTotale += originale;
                        prezzoScontato += scontato;
                        descrizioneEstesa += `<li>${prodotto.titolo} - ‚Ç¨${originale.toFixed(2)} ‚Üí <strong>-${sconto}%</strong> = ‚Ç¨${scontato.toFixed(2)}</li>`;
                    });
                    descrizioneEstesa += '</ul>';
                }
                // <td>Nome</td>, <td>Descrizione</td>, <td>Prezzo</td>, <td>Attiva</td>
                const tr = document.createElement("tr");
                tr.innerHTML = `
                  <td>${promo.nome}</td>
                  <td>
                    ${promo.descrizione ? `<div>${promo.descrizione}</div>` : ''}
                    <div><small>üóìÔ∏è ${promo.dataInizio} ‚Üí ${promo.dataFine}</small></div>
                    ${descrizioneEstesa}
                  </td>
                  <td>
                    ${prezzoTotale > 0 ? `<del>‚Ç¨${prezzoTotale.toFixed(2)}</del> ‚Üí <strong>‚Ç¨${prezzoScontato.toFixed(2)}</strong>` : '--'}
                  </td>
                  <td>
                    <input type="checkbox" ${promo.attiva ? 'checked' : ''} onchange="togglePromoAttiva(${promo.id}, this.checked)">
                    <button class="btn btn-sm btn-danger ml-2" onclick="eliminaPromozione(${promo.id})">Elimina</button>
                  </td>
                `;
                promozioniTableBody.appendChild(tr);
            });

        document.querySelectorAll('.promo-checkbox').forEach(cb => {
            cb.addEventListener('change', () => {
                const checked = Array.from(document.querySelectorAll('.promo-checkbox:checked'));
                const summary = checked.map(c => c.dataset.title).join(', ');
                const box = document.getElementById('selectedPromoSummary');
                if (checked.length > 0) {
                    box.style.display = 'block';
                    box.innerHTML = `<strong>Prodotti selezionati:</strong> ${summary}`;
                } else {
                    box.style.display = 'none';
                }
            });
        });
    }

    // Funzione per attivare/disattivare promozione via checkbox
    function togglePromoAttiva(id, checked) {
        if (checked) {
            riattivaPromozione(id);
        } else {
            disattivaPromozione(id);
        }
    }
    function disattivaPromozione(id) {
        if (!confirm("Disattivare questa promozione?")) return;
        fetch(`/admin/promotions/${id}/disattiva`, { method: 'PUT' })
            .then(r => r.ok ? location.reload() : alert("Errore durante la disattivazione."));
    }

    function riattivaPromozione(id) {
        if (!confirm("Riattivare questa promozione?")) return;
        fetch(`/admin/promotions/${id}/attiva`, { method: 'PUT' })
            .then(r => r.ok ? location.reload() : alert("Errore durante la riattivazione."));
    }

    function eliminaPromozione(id) {
        if (!confirm("Eliminare questa promozione?")) return;

        fetch(`/admin/promotions/${id}`, {
            method: 'DELETE'
        })
            .then(res => {
                if (!res.ok) throw new Error();
                location.reload();
            })
            .catch(() => alert("Errore durante l'eliminazione."));
    }
    async function loadUtenti() {
        const res = await fetch('/api/users');
        const utenti = await res.json();
        const tbody = document.getElementById('utentiTableBody');
        tbody.innerHTML = '';
        utenti.forEach(u => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
            <td>${u.id}</td>
            <td>${u.name}</td>
            <td>${u.phone}</td>
            <td>
                <button class="btn btn-sm btn-danger" onclick="eliminaUtente(${u.id})">Elimina</button>
            </td>`;
            tbody.appendChild(tr);
        });
    }
    async function eliminaUtente(id) {
        if (!confirm("Sei sicuro di voler eliminare questo utente?")) return;
        const res = await fetch(`/api/users/${id}`, {
            method: 'DELETE'
        });
        if (res.ok) {
            alert("‚úÖ Utente eliminato.");
            loadUtenti();
        } else {
            alert("‚ùå Errore durante l'eliminazione.");
        }
    }


</script>
</body>
</html>