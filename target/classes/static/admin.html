<!DOCTYPE html>
<html lang="it">
<head>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <title>Corner – Back Office</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        /* Aggiungi alla sezione style */
        #eventRegAvailable.text-danger {
            font-weight: bold;
            color: #dc3545 !important;
        }

        #eventRegAvailable.text-success {
            font-weight: bold;
            color: #28a745 !important;
        }

        .event-registration-card {
            border-left: 4px solid var(--success);
            margin-bottom: 20px;
        }

        .event-registration-header {
            background-color: #f8f9fa;
            padding: 10px 15px;
            border-bottom: 1px solid #dee2e6;
        }
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #212529;
            --light: #f8f9fa;
        }

        body {
            padding: 15px;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            margin-top: 40px;
            margin-bottom: 60px;
            max-width: 1600px;
        }

        .hidden { display: none; }

        /* Header styles */
        .page-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .page-header h2 {
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Section switcher */
        .section-switcher {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .section-btn {
            flex: 1;
            min-width: 160px;
            max-width: 220px;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .section-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Card styles */
        .card-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }

        .card-section h4 {
            color: var(--primary);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tables */
        .custom-table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.03);
        }

        .custom-table th {
            background-color: #f1f5fd;
            color: var(--primary);
            font-weight: 600;
        }

        .custom-table th,
        .custom-table td {
            vertical-align: middle;
            padding: 15px;
            border-top: 1px solid #e9ecef;
        }

        .custom-table tr:last-child td {
            border-bottom: 1px solid #e9ecef;
        }

        /* Images */
        img.thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        /* Forms */
        .form-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        /* Buttons */
        .btn-action {
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Promotions */
        .promo-card {
            background: #fff9f9;
            border-left: 4px solid var(--danger);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .section-btn {
                min-width: 140px;
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .page-header {
                padding: 20px;
            }

            .page-header h2 {
                font-size: 1.5rem;
            }

            .card-section {
                padding: 20px 15px;
            }

            .custom-table th,
            .custom-table td {
                padding: 10px;
                font-size: 0.9rem;
            }

            .form-card {
                padding: 15px;
            }
        }
        /* Eventi styles */
        .event-status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .event-status-available {
            background-color: #d4edda;
            color: #155724;
        }

        .event-status-full {
            background-color: #f8d7da;
            color: #721c24;
        }

        .event-status-unlimited {
            background-color: #e2e3e5;
            color: #383d41;
        }

        .event-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }

        .event-thumb.placeholder {
            background-color: #f1f1f1;
            display: inline-block;
        }
        .allergen-icon{ width:20px; height:20px; margin-right:6px; vertical-align:middle; opacity:.95 }
        .allergen-icon{ width:20px; height:20px; margin-right:6px; vertical-align:middle; opacity:.95 }
        .allergen-chip{ display:inline-flex; align-items:center; gap:6px; margin:4px 8px 0 0; padding:4px 8px; border:1px solid #e9ecef; border-radius:16px; background:#fff }
        .allergen-picker label{ display:flex; align-items:center; gap:8px; padding:6px 8px; border:1px solid #eee; border-radius:8px; margin:6px 8px 0 0; background:#fff }
        .allergen-picker .statuses{ display:inline-flex; gap:8px; margin-left:8px; font-size:.9rem }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="page-header">
        <h2><i class="fas fa-cogs"></i> Back Office – Corner</h2>
    </div>

    <!-- Section Switcher -->
    <div class="section-switcher">
        <button class="btn btn-primary section-btn" onclick="showSection('prenotazioni')">
            <i class="fas fa-calendar-alt"></i> Prenotazioni
        </button>
        <button class="btn btn-info section-btn" onclick="showSection('menu')">
            <i class="fas fa-utensils"></i> Menu
        </button>
        <button class="btn btn-warning section-btn" onclick="showSection('evidenza')">
            <i class="fas fa-star"></i> In Evidenza
        </button>
        <button class="btn btn-danger section-btn" onclick="showSection('promozioni')">
            <i class="fas fa-tag"></i> Promozioni
        </button>
        <button class="btn btn-dark section-btn" onclick="showSection('utenti')">
            <i class="fas fa-users"></i> Utenti
        </button>
        <!-- Nella sezione dei pulsanti di navigazione, aggiungi questo nuovo pulsante -->
        <button class="btn btn-success section-btn" onclick="showSection('eventi')">
            <i class="fas fa-calendar-check"></i> Eventi
        </button>
    </div>

    <!-- Prenotazioni Section -->
    <div id="sectionPrenotazioni" class="card-section">
        <h4><i class="fas fa-calendar-alt"></i> Gestione Prenotazioni</h4>

        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-4" id="bookingTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="table-tab" data-toggle="tab" href="#tableBookings" role="tab">
                    <i class="fas fa-utensils"></i> Prenotazioni Tavolo
                </a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="event-tab" data-toggle="tab" href="#eventRegistrations" role="tab">
                    <i class="fas fa-calendar-check"></i> Registrazioni Eventi
                </a>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- TAB 1: Prenotazioni Tavolo -->
            <div class="tab-pane fade show active" id="tableBookings" role="tabpanel">
                <!-- Form nuova prenotazione tavolo -->
                <div class="form-card mb-4">
                    <h5><i class="fas fa-plus-circle"></i> Nuova Prenotazione Tavolo</h5>
                    <form id="formTableBooking">
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Nome</label>
                                <input type="text" id="tableBookingName" class="form-control" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Telefono</label>
                                <input type="tel" id="tableBookingPhone" class="form-control" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Note</label>
                                <input type="text" id="tableBookingNote" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Data</label>
                                <input type="date" id="tableBookingDate" class="form-control" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Ora</label>
                                <select id="tableBookingTime" class="form-control" required>
                                    <option value="20:00">20:00</option>
                                    <option value="20:30">20:30</option>
                                    <option value="21:00">21:00</option>
                                    <option value="21:30">21:30</option>
                                    <option value="22:00">22:00</option>
                                    <option value="22:30">22:30</option>
                                    <option value="23:00">23:00</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Numero Persone</label>
                                <input type="number" id="tableBookingPeople" class="form-control" min="1" value="2" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Salva Prenotazione
                        </button>
                    </form>
                </div>

                <!-- Lista prenotazioni tavolo -->
                <h5><i class="fas fa-list"></i> Prenotazioni Tavolo</h5>
                <div id="tableBookingsContainer" class="mt-3"></div>
            </div>

            <!-- TAB 2: Registrazioni Eventi -->
            <div class="tab-pane fade" id="eventRegistrations" role="tabpanel">
                <!-- Form nuova registrazione evento -->
                <div class="form-card mb-4">
                    <h5><i class="fas fa-plus-circle"></i> Nuova Registrazione Evento</h5>
                    <form id="formEventRegistration">
                        <div class="form-row">
                            <div class="form-group col-md-4">
                                <label>Nome</label>
                                <input type="text" id="eventRegName" class="form-control" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Telefono</label>
                                <input type="tel" id="eventRegPhone" class="form-control" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Numero Persone</label>
                                <input type="number" id="eventRegPeople" class="form-control" min="1" value="1" required>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Note</label>
                                <input type="text" id="eventRegNote" class="form-control">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group col-md-8">
                                <label>Evento</label>
                                <select id="eventRegEvent" class="form-control" required>
                                    <option value="">Caricamento eventi...</option>
                                </select>
                            </div>
                            <div class="form-group col-md-4">
                                <label>Posti Disponibili</label>
                                <input type="text" id="eventRegAvailable" class="form-control" readonly>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-user-plus"></i> Registra Partecipante
                        </button>
                    </form>
                </div>

                <!-- Lista eventi con iscritti -->
                <h5><i class="fas fa-list"></i> Eventi e Iscritti</h5>
                <div id="eventsRegistrationsContainer" class="mt-3"></div>
            </div>
        </div>
    </div>

    <!-- Menu Section -->
    <div id="sectionMenu" class="card-section hidden">
        <h4><i class="fas fa-utensils"></i> Gestione Menu</h4>

        <!-- Add New Item -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Aggiungi nuovo piatto</h5>
            <form id="formAddNewItem">
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label>Titolo</label>
                        <input type="text" name="titolo" class="form-control" placeholder="Nome del piatto" required />
                    </div>
                    <div class="form-group col-md-2">
                        <label>Categoria</label>
                        <select name="categoria" class="form-control" id="categoriaSelectMenu" required>
                            <option value="">Seleziona Categoria</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3">
                        <label>Descrizione</label>
                        <input type="text" name="descrizione" class="form-control" placeholder="Descrizione" />
                    </div>
                    <div class="form-group col-md-2">
                        <label>Prezzo (€)</label>
                        <input type="number" step="0.01" name="prezzo" class="form-control" placeholder="0.00" required />
                    </div>
                    <div class="form-group col-md-2">
                        <label>Immagine</label>
                        <input type="file" name="image" accept="image/*" class="form-control-file" required />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <label>Visibile</label>
                        <select name="visibile" class="form-control">
                            <option value="true">✅ Sì</option>
                            <option value="false">❌ No</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3 mt-4 pt-2">
                        <button type="submit" class="btn btn-success btn-action">
                            <i class="fas fa-save"></i> Salva Piatto
                        </button>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label><i class="fa-solid fa-triangle-exclamation"></i> Allergeni</label>

                        <!-- nuovo selettore compatto -->
                        <div id="allergenSelectAdd"></div>

                        <small class="text-muted d-block mt-1">
                            Clicca per selezionare uno o più allergeni e imposta “Contiene” o “Tracce”.
                        </small>
                    </div>
                </div>
            </form>
        </div>

        <!-- Menu List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Menu Attuale</h5>
            <div id="menuTablesContainer"></div>
        </div>
    </div>

    <!-- Evidenza Section -->
    <div id="sectionEvidenza" class="card-section hidden">
        <h4><i class="fas fa-star"></i> Contenuti in Evidenza</h4>

        <!-- Add Highlight -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Aggiungi Contenuto</h5>
            <form id="formAddHighlight">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Categoria</label>
                        <select id="categoriaSelectEvidenza" class="form-control" required>
                            <option value="">Seleziona Categoria</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label>Prodotto</label>
                        <select id="prodottoSelectEvidenza" class="form-control" disabled required>
                            <option value="">Seleziona Prodotto</option>
                        </select>
                    </div>
                    <div class="form-group col-md-2 mt-4 pt-2">
                        <button type="submit" class="btn btn-warning btn-action">
                            <i class="fas fa-plus"></i> Aggiungi
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Highlights List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Contenuti Attivi</h5>
            <div id="highlightsContainer" class="mt-3"></div>
        </div>
    </div>

    <!-- Promozioni Section -->
    <div id="sectionPromozioni" class="card-section hidden">
        <h4><i class="fas fa-tag"></i> Gestione Promozioni</h4>

        <!-- Add Promotion -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Crea Nuova Promozione</h5>
            <form id="formAddPromozione">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Nome Promozione</label>
                        <input type="text" class="form-control" name="nome" placeholder="Nome della promozione" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label>Sconto (%)</label>
                        <input type="number" step="1" min="1" max="100" name="sconto" class="form-control" placeholder="%" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label>Descrizione</label>
                        <textarea name="descrizione" class="form-control" placeholder="Descrizione promozione" rows="2"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label>Data Inizio</label>
                        <input type="date" name="dataInizio" class="form-control" required />
                    </div>
                    <div class="form-group col-md-3">
                        <label>Data Fine</label>
                        <input type="date" name="dataFine" class="form-control" required />
                    </div>
                </div>

                <div class="form-row mt-3">
                    <div class="form-group col-md-12">
                        <label><i class="fas fa-list"></i> Prodotti inclusi</label>
                        <div id="checklistProdottiPromozione" class="row mt-2"></div>
                    </div>
                </div>

                <div class="form-row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info" id="selectedPromoSummary" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-row mt-3">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-danger btn-action">
                            <i class="fas fa-fire"></i> Crea Promozione
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Promotions List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Promozioni Attive</h5>
            <div class="table-responsive">
                <table class="table custom-table">
                    <thead class="thead-light">
                    <tr>
                        <th>Nome</th>
                        <th>Descrizione</th>
                        <th>Periodo</th>
                        <th>Sconto</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                    </thead>
                    <tbody id="promozioniTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Utenti Section -->
    <div id="sectionUtenti" class="card-section hidden">
        <h4><i class="fas fa-users"></i> Gestione Utenti</h4>

        <div class="table-responsive">
            <table class="table custom-table">
                <thead class="thead-light">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Telefono</th>
                    <th>Email</th>
                    <th>Registrazione</th>
                    <th>Azioni</th>
                </tr>
                </thead>
                <tbody id="utentiTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Eventi Section -->
    <div id="sectionEventi" class="card-section hidden">
        <h4><i class="fas fa-calendar-check"></i> Gestione Eventi</h4>

        <!-- Add New Event -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Crea Nuovo Evento</h5>
            <form id="formAddEvento">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Titolo</label>
                        <input type="text" name="titolo" class="form-control" placeholder="Titolo evento" required />
                    </div>
                    <div class="form-group col-md-4">
                        <label>Data e Ora</label>
                        <input type="datetime-local" name="data" class="form-control" required />
                    </div>
                    <div class="form-group col-md-4">
                        <label>Posti Totali (lasciare vuoto per illimitati)</label>
                        <input type="number" name="postiTotali" class="form-control" placeholder="Numero posti" min="1" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label>Descrizione</label>
                        <textarea name="descrizione" class="form-control" placeholder="Descrizione evento" rows="3"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label>Locandina (immagine)</label>
                        <input type="file" name="poster" accept="image/*" class="form-control-file">
                    </div>
                </div>
                <div class="form-row mt-3">
                    <div class="form-group col-md-12">
                        <button type="submit" class="btn btn-success btn-action">
                            <i class="fas fa-save"></i> Crea Evento
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Events List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Eventi Programmati</h5>
            <div class="table-responsive">
                <table class="table custom-table">
                    <thead class="thead-light">
                    <tr>
                        <th>Locandina</th>
                        <th>Titolo</th>
                        <th>Descrizione</th>
                        <th>Data</th>
                        <th>Posti</th>
                        <th>Azioni</th>
                    </tr>
                    </thead>
                    <tbody id="eventiTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Iscritti Modal -->
        <div class="modal fade" id="iscrittiModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Iscritti all'evento</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefono</th>
                                    <th>Data Iscrizione</th>
                                    <th>Persone</th>
                                    <th>Note</th> <!-- AGGIUNTO -->
                                </tr>
                                </thead>

                                <tbody id="iscrittiModalBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Utility functions
    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escape(str) {
        if (!str) return '';
        return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleString('it-IT');
    }

    // Section management
    function showSection(section) {
        ['prenotazioni', 'menu', 'evidenza', 'promozioni', 'utenti', 'eventi'].forEach(s => {
            document.getElementById('section' + capitalize(s)).classList.add('hidden');
        });
        document.getElementById('section' + capitalize(section)).classList.remove('hidden');

        if (section === 'prenotazioni') {
            loadTableBookings();
        } else if (section === 'menu') {
            loadMenuItems();

            ensureAllergenCatalog().then(() => renderAllergenSelect('allergenSelectAdd'))
                .catch(err => { console.error(err); renderAllergenSelect('allergenSelectAdd'); });
        } else if (section === 'evidenza') {
            loadInEvidenza();
        } else if (section === 'promozioni') {
            loadPromozioni();
        } else if (section === 'utenti') {
            loadUtenti();
        } else if (section === 'eventi') {
            loadEventi();
        }
    }

    // Prenotazioni functions
    async function loadReservations() {
        try {
            const res = await fetch('/admin/reservations');
            const data = await res.json();
            const grouped = {};
            data.forEach(r => {
                if (!grouped[r.date]) grouped[r.date] = [];
                grouped[r.date].push(r);
            });

            const container = document.getElementById('reservationsByDateContainer');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h4>Nessuna prenotazione trovata</h4>
                        <p>Non ci sono prenotazioni registrate al momento</p>
                    </div>
                `;
                return;
            }

            Object.keys(grouped).sort().forEach(date => {
                const section = document.createElement('div');
                section.classList.add('mb-5');

                const rows = grouped[date].map(r => `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.phone}</td>
                        <td>${r.time}</td>
                        <td>${r.people}</td>
                        <td>${r.note || '-'}</td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteReservation(${r.id})">
                                <i class="fas fa-trash-alt"></i> Elimina
                            </button>
                        </td>
                    </tr>
                `).join('');

                section.innerHTML = `
                    <h5 class="d-flex align-items-center">
                        <i class="fas fa-calendar-day me-2"></i> ${formatDate(date)}
                    </h5>
                    <div class="table-responsive">
                        <table class="table custom-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefono</th>
                                    <th>Ora</th>
                                    <th>Persone</th>
                                    <th>Note</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
                container.appendChild(section);
            });
        } catch (error) {
            console.error('Error loading reservations:', error);
            document.getElementById('reservationsByDateContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Errore durante il caricamento delle prenotazioni
                </div>
            `;
        }
    }

    async function deleteReservation(id) {
        if (!confirm('Vuoi davvero eliminare questa prenotazione?')) return;
        try {
            const res = await fetch(`/admin/reservations/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadReservations();
            } else {
                alert('Errore durante l\'eliminazione.');
            }
        } catch (error) {
            console.error('Error deleting reservation:', error);
            alert('Errore durante l\'eliminazione.');
        }
    }

    // Menu functions
    function populateSelect(context, categories) {
        const select = document.getElementById(`categoriaSelect${context}`);
        select.innerHTML = '<option value="">Seleziona Categoria</option>';
        categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            select.appendChild(opt);
        });
    }
        // === Allergen Picker utilities ===
        // === Catalogo allergeni ===
        let ALLERGEN_CATALOG = [];
        // === Global for edit lock (menu) ===
        let CURRENT_EDIT_ID = null;

        async function ensureAllergenCatalog() {
        if (ALLERGEN_CATALOG.length) return;
        const res = await fetch('/admin/menu/allergens');
        if (!res.ok) throw new Error('Errore caricamento allergeni');
        ALLERGEN_CATALOG = await res.json(); // [{code,label,iconUrl,status:'FREE'}...]
    }

        // === Multi-selettore a dropdown ===
        // containerId: es. "allergenSelectAdd" o "allergenSelectEdit-123"
        // preselectedMap: { MILK: 'CONTAINS', SOYBEANS: 'MAY_CONTAIN' }
        function renderAllergenSelect(containerId, preselectedMap = {}) {
        const root = document.getElementById(containerId);
        if (!root) return;

        // bottone + dropdown Bootstrap
        root.innerHTML = `
    <div class="dropdown">
      <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Seleziona allergeni
      </button>
      <div class="dropdown-menu p-3" style="max-height: 360px; overflow:auto; min-width: 420px;">
        <div id="${containerId}-list"></div>
      </div>
    </div>
    <div id="${containerId}-summary" class="mt-2"></div>
  `;

        // lista elementi (checkbox + select status)
        const list = document.getElementById(`${containerId}-list`);
        list.innerHTML = ALLERGEN_CATALOG.map(a => {
        const checked = preselectedMap[a.code] ? 'checked' : '';
        const current = (preselectedMap[a.code] || 'FREE').toUpperCase();
        const disabled = checked ? '' : 'disabled';

            return `
  <div class="d-flex align-items-center mb-2">
    <input type="checkbox" class="mr-2" id="${containerId}-chk-${a.code}" ${checked}>
    <div class="flex-grow-1">
      <div class="font-weight-bold">${a.label}</div>
      <div class="small text-muted">${a.code}</div>
    </div>
    <select id="${containerId}-status-${a.code}" class="form-control form-control-sm" style="width:160px" ${disabled}>
      <option value="CONTAINS" ${current==='CONTAINS'?'selected':''}>Contiene</option>
      <option value="MAY_CONTAIN" ${current==='MAY_CONTAIN'?'selected':''}>Tracce</option>
    </select>
  </div>
`;
    }).join('');

        // abilitazione/disabilitazione select status
        ALLERGEN_CATALOG.forEach(a => {
        const chk = document.getElementById(`${containerId}-chk-${a.code}`);
        const sel = document.getElementById(`${containerId}-status-${a.code}`);
        chk.addEventListener('change', () => {
        sel.disabled = !chk.checked;
        updateSummary(containerId);
    });
        sel.addEventListener('change', () => updateSummary(containerId));
    });

        updateSummary(containerId);
    }

        // Legge il selezionato: array di {code, status} (FREE viene escluso)
        function readAllergenSelect(containerId) {
        const selected = [];
        ALLERGEN_CATALOG.forEach(a => {
        const chk = document.getElementById(`${containerId}-chk-${a.code}`);
        const sel = document.getElementById(`${containerId}-status-${a.code}`);
        if (chk && chk.checked) {
        selected.push({ code: a.code, status: sel.value.toUpperCase() });
    }
    });
        return selected;
    }

        // badge riepilogo sotto al pulsante
        function updateSummary(containerId) {
        const wrap = document.getElementById(`${containerId}-summary`);
        const chosen = readAllergenSelect(containerId);
        if (!chosen.length) {
        wrap.innerHTML = `<span class="text-muted small">Nessun allergene selezionato</span>`;
        return;
    }
        wrap.innerHTML = chosen.map(s => `
    <span class="badge badge-light mr-1 mb-1">
      ${s.code} — ${s.status==='CONTAINS' ? 'Contiene' : 'Tracce'}
    </span>
  `).join('');
    }

    document.addEventListener('DOMContentLoaded', async () => {
        showSection('prenotazioni');

        // Carica catalogo allergeni e renderizza il selettore compatto dell'ADD
        try {
            await ensureAllergenCatalog();
            renderAllergenSelect('allergenSelectAdd');
        } catch (e) {
            console.error(e);
        }
    });


    async function loadMenuItems() {
        CURRENT_EDIT_ID = null;
        try {
            const res = await fetch('/admin/menu');
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();

            const grouped = {};
            (data || []).forEach(item => {
                const cat = item.categoria || 'Altro';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(item);
            });

            populateSelect('Menu', Object.keys(grouped));
            const container = document.getElementById('menuTablesContainer');
            container.innerHTML = '';

            if (!data || data.length === 0) {
                container.innerHTML = `
        <div class="alert alert-info text-center">
          <i class="fas fa-info-circle fa-2x mb-3"></i>
          <h4>Menu vuoto</h4>
          <p>Non ci sono piatti nel menu al momento</p>
        </div>`;
                return;
            }

            Object.keys(grouped).sort().forEach(cat => {
                const section = document.createElement('div');
                section.classList.add('mb-5');

                const rows = grouped[cat].map(item => {
                    const safeId = Number(item.id);
                    const imgSrc = (item.imageUrl && item.imageUrl.trim() !== '')
                        ? item.imageUrl
                        : `https://res.cloudinary.com/dytvizqtq/image/upload/prodotti/${safeId}.png`;

                    // ——— testo allergeni sotto la descrizione ———
                    const allergensText = ((item.allergens || [])
                        .filter(a => a && a.status && a.status !== 'FREE')
                        .map(a => {
                            const label = (a.label || a.code || '').toString();
                            const status = (a.status || '').toString().toUpperCase();
                            return `${label}${status === 'MAY_CONTAIN' ? ' (tracce)' : ' (contiene)'}`;
                        }))
                        .join(', ');

                    return `
          <tr id="menu-row-${safeId}">
            <td><img src="${imgSrc}" onerror="this.onerror=null;this.src='/img/placeholder.png'" class="thumb" /></td>
            <td>${escape(item.titolo || '')}</td>
            <td>
              ${escape(item.descrizione || '-')}
              ${allergensText
                        ? `<div class="small text-muted mt-1"><strong>Allergeni:</strong> ${escape(allergensText)}</div>`
                        : ``}
            </td>
            <td>€${Number(item.prezzo || 0).toFixed(2)}</td>
            <td>
              <button class="status-badge btn btn-sm ${item.visibile ? 'bg-success' : 'bg-secondary'}"
                      onclick="toggleVisibility(${safeId})" title="Clicca per cambiare stato">
                ${item.visibile ? 'Visibile' : 'Nascosto'}
              </button>
            </td>
            <td>-</td>
            <td class="text-nowrap">
              <button class="btn btn-sm btn-warning btn-action"
                onclick="makeEditable(${safeId}, '${escape(item.titolo || '')}', '${escape(item.categoria || '')}', '${escape(item.descrizione || '')}', ${Number(item.prezzo || 0)})">
                <i class="fas fa-edit"></i> Modifica
              </button>
              <button class="btn btn-sm btn-danger btn-action" onclick="deleteMenuItem(${safeId})">
                <i class="fas fa-trash-alt"></i> Elimina
              </button>
            </td>
          </tr>`;
                }).join('');

                section.innerHTML = `
        <h5 class="d-flex align-items-center">
          <i class="fas fa-utensils me-2"></i> ${escape(cat)}
        </h5>
        <div class="table-responsive">
          <table class="table custom-table">
            <thead class="thead-light">
              <tr>
                <th>Foto</th>
                <th>Titolo</th>
                <th>Descrizione</th>
                <th>Prezzo</th>
                <th>Stato</th>
                <th>Allergeni</th>
                <th>Azioni</th>
              </tr>
            </thead>
            <tbody>${rows}</tbody>
          </table>
        </div>`;
                container.appendChild(section);
            });
        } catch (error) {
            console.error('Error loading menu items:', error);
            document.getElementById('menuTablesContainer').innerHTML = `
      <div class="alert alert-danger">
        <i class="fas fa-exclamation-triangle"></i> Errore durante il caricamento del menu
      </div>`;
        }
    }

    document.getElementById('formAddNewItem').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;

        const allergens = readAllergenSelect('allergenSelectAdd');

        const data = {
            titolo: form.titolo.value,
            categoria: form.categoria.value,
            descrizione: form.descrizione.value,
            prezzo: parseFloat(form.prezzo.value),
            visibile: form.visibile.value === 'true',
            allergens
        };

        const formData = new FormData();
        formData.append('data', new Blob([JSON.stringify(data)], { type: 'application/json' }));
        if (form.image.files[0]) formData.append('image', form.image.files[0]);

        try {
            const res = await fetch('/admin/menu', { method: 'POST', body: formData });
            if (res.ok) {
                alert('✅ Piatto aggiunto con successo!');
                form.reset();
                // reset anche il selettore allergeni
                renderAllergenSelect('allergenSelectAdd');
                await loadMenuItems();
            } else {
                alert('❌ Errore durante l\'aggiunta del piatto');
            }
        } catch (error) {
            console.error('Error adding menu item:', error);
            alert('❌ Errore durante l\'aggiunta del piatto');
        }
    });

    async function toggleVisibility(id) {
        try {
            await fetch(`/admin/menu/${id}/toggle`, { method: 'PATCH' });
            await loadMenuItems();
        } catch (error) {
            console.error('Error toggling visibility:', error);
            alert('Errore durante l\'aggiornamento dello stato');
        }
    }

    async function deleteMenuItem(id) {
        if (!confirm('Sei sicuro di voler eliminare questo piatto?')) return;
        try {
            await fetch(`/admin/menu/${id}`, { method: 'DELETE' });
            if (CURRENT_EDIT_ID === id) CURRENT_EDIT_ID = null;
            await loadMenuItems();
        } catch (error) {
            console.error('Error deleting menu item:', error);
            alert('Errore durante l\'eliminazione del piatto');
        }
    }

    async function makeEditable(id, titolo, categoria, descrizione, prezzo) {
        if (CURRENT_EDIT_ID !== null && CURRENT_EDIT_ID !== id) {
            alert('Puoi modificare solo un elemento alla volta. Prima salva o annulla quello in modifica.');
            return;
        }
        CURRENT_EDIT_ID = id;
        const row = document.getElementById(`menu-row-${id}`);
        row.innerHTML = `
    <td><input type="file" id="edit-image-${id}" accept="image/*" class="form-control-file" /></td>
    <td><input type="text" id="edit-titolo-${id}" value="${titolo}" class="form-control" /></td>
    <td><input type="text" id="edit-desc-${id}" value="${descrizione}" class="form-control" /></td>
    <td><input type="number" id="edit-prezzo-${id}" value="${prezzo}" step="0.01" class="form-control" /></td>
    <td><input type="text" id="edit-cat-${id}" value="${categoria}" class="form-control" /></td>
    <td colspan="2">
      <div class="mb-2"><strong>Allergeni</strong></div>
      <div id="allergenSelectEdit-${id}"></div>
    </td>
    <td class="text-nowrap">
      <button class="btn btn-sm btn-success btn-action" onclick="submitEdit(${id})">
        <i class="fas fa-check"></i> Salva
      </button>
      <button class="btn btn-sm btn-secondary btn-action" onclick="CURRENT_EDIT_ID=null; loadMenuItems();">
        <i class="fas fa-times"></i> Annulla
      </button>
    </td>
  `;

        try {
            await ensureAllergenCatalog();
            const detailRes = await fetch(`/api/menu/${id}`);
            const item = await detailRes.json();

            const pre = {};
            (item.allergens || []).forEach(a => pre[a.code] = a.status); // CONTAINS/MAY_CONTAIN
            renderAllergenSelect(`allergenSelectEdit-${id}`, pre);
        } catch (e) {
            console.error('Impossibile caricare allergeni per edit:', e);
            renderAllergenSelect(`allergenSelectEdit-${id}`, {});
        }
    }

    async function submitEdit(id) {
        const titolo = document.getElementById(`edit-titolo-${id}`).value;
        const descrizione = document.getElementById(`edit-desc-${id}`).value;
        const prezzo = parseFloat(document.getElementById(`edit-prezzo-${id}`).value);
        const categoria = document.getElementById(`edit-cat-${id}`).value;
        const imageInput = document.getElementById(`edit-image-${id}`);

        const allergens = readAllergenSelect(`allergenSelectEdit-${id}`);

        const data = { titolo, descrizione, prezzo, categoria, allergens };

        const formData = new FormData();
        formData.append('data', new Blob([JSON.stringify(data)], { type: 'application/json' }));
        if (imageInput.files.length > 0) formData.append('image', imageInput.files[0]);

        try {
            const res = await fetch(`/admin/menu/${id}`, { method: 'PUT', body: formData });
            if (!res.ok) throw new Error('Update failed');
            CURRENT_EDIT_ID = null;
            loadMenuItems();
        } catch (error) {
            console.error('Error updating menu item:', error);
            alert('Errore durante l\'aggiornamento del piatto');
        }
    }

    // Evidenza functions
    async function loadInEvidenza() {
        try {
            const [menuRes, evidenzaRes] = await Promise.all([
                fetch('/admin/menu'),
                fetch('/admin/in_evidenza')
            ]);

            const menuData = await menuRes.json();
            const evidenzaData = await evidenzaRes.json();

            const idToTitolo = {};
            menuData.forEach(item => {
                idToTitolo[item.id] = item.titolo;
            });

            const categories = [...new Set(menuData.map(i => i.categoria))].sort();
            populateSelect('Evidenza', categories);

            const container = document.getElementById('highlightsContainer');
            container.innerHTML = '';

            if (evidenzaData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Nessun contenuto in evidenza al momento
                    </div>
                `;
                return;
            }

            evidenzaData.forEach(h => {
                const itemId = h.itemId || h.item_id;
                const titolo = idToTitolo[itemId] || 'Titolo non disponibile';

                const div = document.createElement('div');
                div.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'border-bottom', 'pb-2', 'mb-3');
                div.innerHTML = `
                    <div>
                        <span class="badge bg-primary me-2">${h.categoria}</span>
                        <strong>${titolo}</strong>
                    </div>
                    <button class="btn btn-sm btn-danger btn-action" onclick="deleteInEvidenza(${h.id})">
                        <i class="fas fa-times"></i> Rimuovi
                    </button>
                `;
                container.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading highlights:', error);
            document.getElementById('highlightsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Errore durante il caricamento dei contenuti in evidenza
                </div>
            `;
        }
    }

    document.getElementById('categoriaSelectEvidenza').addEventListener('change', async e => {
        const cat = e.target.value;
        const prodSelect = document.getElementById('prodottoSelectEvidenza');
        prodSelect.innerHTML = '<option value="">Seleziona Prodotto</option>';

        if (!cat) {
            prodSelect.disabled = true;
            return;
        }

        try {
            const res = await fetch('/admin/menu');
            const items = (await res.json()).filter(i => i.categoria === cat);

            items.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.id;
                opt.textContent = i.titolo;
                prodSelect.appendChild(opt);
            });

            prodSelect.disabled = false;
        } catch (error) {
            console.error('Error loading products:', error);
        }
    });

    document.getElementById('formAddHighlight').addEventListener('submit', async e => {
        e.preventDefault();
        const cat = document.getElementById('categoriaSelectEvidenza').value;
        const prodId = document.getElementById('prodottoSelectEvidenza').value;

        if (!cat || !prodId) {
            alert('Seleziona sia la categoria che il prodotto');
            return;
        }

        try {
            const res = await fetch('/admin/in_evidenza', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categoria: cat, itemId: prodId })
            });

            if (res.ok) {
                loadInEvidenza();
                e.target.reset();
                document.getElementById('prodottoSelectEvidenza').disabled = true;
            } else {
                alert('Errore durante l\'aggiunta del contenuto in evidenza');
            }
        } catch (error) {
            console.error('Error adding highlight:', error);
            alert('Errore durante l\'aggiunta del contenuto in evidenza');
        }
    });

    async function deleteInEvidenza(id) {
        if (!confirm('Sei sicuro di voler rimuovere questo contenuto in evidenza?')) return;

        try {
            const res = await fetch(`/admin/in_evidenza/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadInEvidenza();
            } else {
                alert('Errore durante la rimozione');
            }
        } catch (error) {
            console.error('Error deleting highlight:', error);
            alert('Errore durante la rimozione');
        }
    }

    // Promozioni functions
    async function loadPromozioni() {
        const checklist = document.getElementById('checklistProdottiPromozione');
        const promozioniTableBody = document.getElementById('promozioniTableBody');

        // helper per stampare una riga di errore in tabella
        const showErrorRow = (msg) => {
            if (!promozioniTableBody) return;
            promozioniTableBody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center py-4 text-danger">
          <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
          <p>${msg}</p>
        </td>
      </tr>`;
        };

        try {
            const [menuRes, promoRes] = await Promise.all([
                fetch('/admin/menu'),
                fetch('/admin/promotions')
            ]);

            // --- MENU ---
            if (!menuRes.ok) {
                const t = await menuRes.text().catch(() => '');
                console.error('GET /admin/menu failed:', menuRes.status, t);
                // Non blocco: la tabella promo può comunque tentare di mostrarsi
            }
            const menuData = menuRes.ok ? await menuRes.json() : [];

            // Build checklist prodotti (solo se presente il container)
            if (checklist) {
                const grouped = {};
                (Array.isArray(menuData) ? menuData : []).forEach(item => {
                    const cat = item.categoria || 'Altro';
                    (grouped[cat] ||= []).push(item);
                });
                checklist.innerHTML = '';
                Object.keys(grouped).sort().forEach(categoria => {
                    const section = document.createElement('div');
                    section.classList.add('col-md-6', 'mb-4');
                    section.innerHTML = `
          <div class="card h-100">
            <div class="card-header bg-light"><strong>${categoria}</strong></div>
            <div class="card-body">
              ${grouped[categoria].map(item => `
                <div class="form-check mb-2">
                  <input class="form-check-input promo-checkbox" type="checkbox"
                         value="${item.id}" id="prod-${item.id}" data-title="${item.titolo}">
                  <label class="form-check-label" for="prod-${item.id}">
                    ${item.titolo} <span class="text-muted">(€${Number(item.prezzo).toFixed(2)})</span>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>`;
                    checklist.appendChild(section);
                });

                // listener dei checkbox
                document.querySelectorAll('.promo-checkbox').forEach(cb => {
                    cb.addEventListener('change', updatePromoSummary);
                });
            }

            // --- PROMOZIONI ---
            if (!promozioniTableBody) return;

            if (!promoRes.ok) {
                const t = await promoRes.text().catch(() => '');
                console.error('GET /admin/promotions failed:', promoRes.status, t);
                showErrorRow('Errore durante il caricamento delle promozioni');
                return;
            }

            let promoData;
            try {
                promoData = await promoRes.json();
            } catch (e) {
                console.error('Promotions JSON parse error:', e);
                showErrorRow('Risposta non valida dal server (promozioni)');
                return;
            }

            if (!Array.isArray(promoData)) {
                console.error('Promotions not an array:', promoData);
                showErrorRow('Risposta inattesa dal server (promozioni)');
                return;
            }

            if (promoData.length === 0) {
                promozioniTableBody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center py-4">
            <i class="fas fa-tag fa-2x mb-3 text-muted"></i>
            <p class="mb-0">Nessuna promozione attiva</p>
          </td>
        </tr>`;
                return;
            }

            // ordina per dataInizio crescente (se mancano le date, le mette in coda)
            promoData.sort((a, b) => {
                const da = a?.dataInizio ? new Date(a.dataInizio) : null;
                const db = b?.dataInizio ? new Date(b.dataInizio) : null;
                if (da && db) return da - db;
                if (da && !db) return -1;
                if (!da && db) return 1;
                return 0;
            });

            promozioniTableBody.innerHTML = '';
            const today = new Date();

            promoData.forEach(promo => {
                const startDate = promo.dataInizio ? new Date(promo.dataInizio) : null;
                const endDate   = promo.dataFine   ? new Date(promo.dataFine)   : null;
                const isActive =
                    (!!startDate ? today >= startDate : true) &&
                    (!!endDate   ? today <= endDate   : true);

                // se la struttura items è diversa, non rompiamo
                let sconto = 0;
                if (Array.isArray(promo.items) && promo.items.length > 0) {
                    // supporta sia item.scontoPercentuale che item.sconto
                    const first = promo.items[0];
                    sconto = Number(first.scontoPercentuale ?? first.sconto ?? 0);
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
        <td>
          <strong>${promo.nome ?? '-'}</strong>
          <div class="small text-muted">${promo.descrizione || 'Nessuna descrizione'}</div>
        </td>
        <td>${promo.descrizione || '-'}</td>
        <td>
          ${promo.dataInizio ? formatDate(promo.dataInizio) : '-'}<br>
          <span class="text-muted small">al</span><br>
          ${promo.dataFine ? formatDate(promo.dataFine) : '-'}
        </td>
        <td class="text-center">
          <span class="badge bg-danger p-2">${sconto}%</span>
        </td>
        <td>
          <span class="status-badge ${isActive ? 'bg-success' : 'bg-secondary'}">
            ${isActive ? 'Attiva' : 'Non attiva'}
          </span>
        </td>
        <td class="text-nowrap">
          <button class="btn btn-sm btn-danger btn-action" onclick="eliminaPromozione(${promo.id})">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>`;
                promozioniTableBody.appendChild(tr);
            });

        } catch (err) {
            console.error('Error loading promotions:', err);
            showErrorRow('Errore durante il caricamento delle promozioni');
        }
    }



    function updatePromoSummary() {
        const checked = Array.from(document.querySelectorAll('.promo-checkbox:checked'));
        const summary = checked.map(c => c.dataset.title).join(', ');
        const box = document.getElementById('selectedPromoSummary');

        if (checked.length > 0) {
            box.style.display = 'block';
            box.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>${checked.length} prodotti selezionati:</strong> ${summary}
            `;
        } else {
            box.style.display = 'none';
        }
    }

    document.getElementById('formAddPromozione').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const nome = form.nome.value;
        const sconto = parseFloat(form.sconto.value);
        const descrizione = form.descrizione.value;
        const dataInizio = form.dataInizio.value;
        const dataFine = form.dataFine.value;

        const selectedCheckboxes = Array.from(document.querySelectorAll('.promo-checkbox:checked'));
        if (selectedCheckboxes.length === 0) {
            alert("Seleziona almeno un prodotto!");
            return;
        }

        const items = selectedCheckboxes.map(cb => ({
            menuItemId: parseInt(cb.value),
            scontoPercentuale: sconto
        }));

        const payload = {
            nome,
            descrizione,
            dataInizio,
            dataFine,
            attiva: true,
            items
        };

        try {
            const res = await fetch('/admin/promotions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("✅ Promozione creata con successo!");
                form.reset();
                document.getElementById('selectedPromoSummary').style.display = 'none';
                loadPromozioni();
            } else {
                alert("❌ Errore durante la creazione della promozione");
            }
        } catch (error) {
            console.error('Error creating promotion:', error);
            alert("❌ Errore durante la creazione della promozione");
        }
    });

    async function eliminaPromozione(id) {
        if (!confirm("Sei sicuro di voler eliminare questa promozione?")) return;

        try {
            const res = await fetch(`/admin/promotions/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadPromozioni();
            } else {
                alert("Errore durante l'eliminazione della promozione");
            }
        } catch (error) {
            console.error('Error deleting promotion:', error);
            alert("Errore durante l'eliminazione della promozione");
        }
    }

    // Utenti functions
    async function loadUtenti() {
        try {
            const res = await fetch('/api/users');
            const utenti = await res.json();
            const tbody = document.getElementById('utentiTableBody');
            tbody.innerHTML = '';

            if (utenti.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-user-slash fa-2x mb-3 text-muted"></i>
                            <p class="mb-0">Nessun utente registrato</p>
                        </td>
                    </tr>
                `;
                return;
            }

            utenti.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${u.email || '-'}</td>
                    <td>${u.createdAt ? formatDateTime(u.createdAt) : '-'}</td>
                    <td class="text-nowrap">
                        <button class="btn btn-sm btn-danger btn-action" onclick="eliminaUtente(${u.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('utentiTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Errore durante il caricamento degli utenti</p>
                    </td>
                </tr>
            `;
        }
    }

    async function eliminaUtente(id) {
        if (!confirm("Sei sicuro di voler eliminare questo utente?")) return;

        try {
            const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert("✅ Utente eliminato con successo");
                loadUtenti();
            } else {
                alert("❌ Errore durante l'eliminazione dell'utente");
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert("❌ Errore durante l'eliminazione dell'utente");
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        showSection('prenotazioni');
    });

    // Eventi functions
    async function loadEventi() {
        try {
            const res = await fetch('/admin/events');
            const eventi = await res.json();
            const tbody = document.getElementById('eventiTableBody');
            tbody.innerHTML = '';

            if (eventi.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4">
                        <i class="fas fa-calendar-times fa-2x mb-3 text-muted"></i>
                        <p class="mb-0">Nessun evento programmato</p>
                    </td>
                </tr>
            `;
                return;
            }

            eventi.forEach(evento => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td>
                    ${evento.posterUrl
                        ? `<img src="${evento.posterUrl}" class="event-thumb" alt="Locandina evento">`
                        : `<div class="event-thumb placeholder"></div>`}
                </td>
                <td><strong>${escape(evento.titolo)}</strong></td>
                <td>${escape(evento.descrizione || '-')}</td>
                <td>${formatDateTime(evento.data)}</td>
                <td>
                    ${evento.postiTotali ?
                    `${evento.postiOccupati}/${evento.postiTotali} (${evento.postiDisponibili} disponibili)` :
                    'Illimitati'}
                </td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-info btn-action" onclick="viewIscritti(${evento.id})">
                        <i class="fas fa-users"></i> Iscritti
                    </button>
                    <button class="btn btn-sm btn-danger btn-action" onclick="deleteEvento(${evento.id})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('eventiTableBody').innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>Errore durante il caricamento degli eventi</p>
                </td>
            </tr>
        `;
        }
    }

    async function viewIscritti(eventId) {
        try {
            const res = await fetch(`/admin/events/${eventId}/attendees`);
            const iscritti = await res.json();

            const modalBody = document.getElementById('iscrittiModalBody');
            modalBody.innerHTML = '';

            if (iscritti.length === 0) {
                modalBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-user-slash fa-2x mb-3 text-muted"></i>
                        <p class="mb-0">Nessun iscritto a questo evento</p>
                    </td>
                </tr>
                </tr>
            `;
            } else {
                iscritti.forEach(iscritto => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${escape(iscritto.name || '-')}</td>
                    <td>${escape(iscritto.phone || '-')}</td>
                    <td>${formatDateTime(iscritto.createdAt)}</td>
                    <td>${iscritto.partecipanti || 1}</td>
                    <td>${escape(iscritto.note || '-')}</td>
                `;
                    modalBody.appendChild(tr);
                });
            }

            $('#iscrittiModal').modal('show');
        } catch (error) {
            console.error('Error loading registrations:', error);
            alert('Errore durante il caricamento degli iscritti');
        }
    }


    async function deleteEvento(id) {
        if (!confirm('Sei sicuro di voler eliminare questo evento?')) return;

        try {
            const res = await fetch(`/admin/events/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadEventi();
            } else {
                alert('Errore durante l\'eliminazione dell\'evento');
            }
        } catch (error) {
            console.error('Error deleting event:', error);
            alert('Errore durante l\'eliminazione dell\'evento');
        }
    }

document.getElementById('formAddEvento').addEventListener('submit', async e => {
    e.preventDefault();
    const form = e.target;

    // Costruisci FormData per invio multipart (no Content-Type esplicito)
    const formData = new FormData();
    formData.append('titolo', form.titolo.value);
    formData.append('descrizione', form.descrizione.value);
    formData.append('data', form.data.value);
    if (form.postiTotali.value) formData.append('postiTotali', form.postiTotali.value);
    if (form.poster && form.poster.files && form.poster.files[0]) {
        formData.append('poster', form.poster.files[0]);
    }

    try {
        const res = await fetch('/admin/events', {
            method: 'POST',
            body: formData
        });

        if (res.ok) {
            alert('✅ Evento creato con successo!');
            form.reset();
            loadEventi();
        } else {
            alert('❌ Errore durante la creazione dell\'evento');
        }
    } catch (error) {
        console.error('Error creating event:', error);
        alert('❌ Errore durante la creazione dell\'evento');
    }
});
    // Gestione Tab Prenotazioni
    document.addEventListener('DOMContentLoaded', function() {
        // Imposta data di default per prenotazioni tavolo
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('tableBookingDate').value = today;
        document.getElementById('tableBookingDate').min = today;

        // Carica gli eventi per la registrazione
        loadEventsForRegistration();

        // Mostra tab prenotazioni all'inizio
        loadTableBookings();

        // Gestione cambio tab
        $('#bookingTabs a').on('click', function(e) {
            e.preventDefault();
            $(this).tab('show');

            if (this.getAttribute('href') === '#eventRegistrations') {
                loadEventRegistrations();
            } else {
                loadTableBookings();
            }
        });
    });

    // Carica gli eventi per il form di registrazione
    // Carica gli eventi per il form di registrazione
    async function loadEventsForRegistration() {
        try {
            const res = await fetch('/admin/events');
            const eventi = await res.json();
            const select = document.getElementById('eventRegEvent');

            select.innerHTML = eventi.length > 0
                ? '<option value="">Seleziona Evento</option>'
                : '<option value="">Nessun evento disponibile</option>';

            eventi.forEach(evento => {
                // Calcola posti disponibili
                const postiDisponibili = evento.postiTotali
                    ? evento.postiTotali - (evento.postiOccupati || 0)
                    : null;

                const opt = document.createElement('option');
                opt.value = evento.id;
                opt.textContent = `${evento.titolo} (${formatDate(evento.data)})`;
                opt.dataset.available = postiDisponibili !== null ? postiDisponibili : 'Illimitati';
                select.appendChild(opt);
            });

            // Aggiorna posti disponibili quando cambia evento
            select.addEventListener('change', function() {
                const selected = this.options[this.selectedIndex];
                const available = selected.dataset.available;

                const availableInput = document.getElementById('eventRegAvailable');
                availableInput.value = available;

                // Aggiungi classe CSS in base alla disponibilità
                if (available === '0') {
                    availableInput.classList.add('text-danger');
                    availableInput.classList.remove('text-success');
                } else if (available === 'Illimitati') {
                    availableInput.classList.remove('text-danger', 'text-success');
                } else {
                    availableInput.classList.add('text-success');
                    availableInput.classList.remove('text-danger');
                }
            });
        } catch (error) {
            console.error('Error loading events:', error);
            alert('Errore nel caricamento degli eventi');
        }
    }

    // Carica prenotazioni tavolo
    async function loadTableBookings() {
        try {
            const res = await fetch('/admin/reservations?type=table');
            const bookings = await res.json();
            const container = document.getElementById('tableBookingsContainer');

            if (bookings.length === 0) {
                container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Nessuna prenotazione tavolo trovata
                </div>
            `;
                return;
            }

            // Raggruppa per data
            const grouped = {};
            bookings.forEach(b => {
                if (!grouped[b.date]) grouped[b.date] = [];
                grouped[b.date].push(b);
            });

            // Crea le sezioni per data
            container.innerHTML = '';
            Object.keys(grouped).sort().forEach(date => {
                const section = document.createElement('div');
                section.classList.add('mb-4');

                const rows = grouped[date].map(b => `
                    <tr>
                        <td>${b.name}</td>
                        <td>${b.phone}</td>
                        <td>${b.time}</td>
                        <td>${b.people}</td>
                        <td>${b.note || '-'}</td>
                        <td>
                            <input type="text" id="table-${b.id}" class="form-control form-control-sm"
                                   value="${b.tableNumber || ''}" placeholder="Tavolo" />
                        </td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-success" onclick="updateTable(${b.id})">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteTableBooking(${b.id})">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');



                section.innerHTML = `
                <h6 class="text-primary">
                    <i class="fas fa-calendar-day"></i> ${formatDate(date)}
                </h6>
                <div class="table-responsive">
                    <table class="table custom-table">
                       <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Telefono</th>
                                <th>Orario</th>
                                <th>Persone</th>
                                <th>Note</th>
                                <th>Tavolo</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>

                        <tbody>${rows}</tbody>
                    </table>
                </div>
            `;
                container.appendChild(section);
            });
        } catch (error) {
            console.error('Error loading table bookings:', error);
            document.getElementById('tableBookingsContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Errore nel caricamento
            </div>
        `;
        }
    }

    // Carica registrazioni eventi
    async function loadEventRegistrations() {
        try {
            const res = await fetch('/admin/events/registrations');
            const registrations = await res.json();
            const container = document.getElementById('eventsRegistrationsContainer');

            container.innerHTML = '';

            if (registrations.length === 0) {
                container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Nessun evento con iscritti
                </div>
            `;
                return;
            }

            // Group registrations by event
            const eventsMap = new Map();
            registrations.forEach(reg => {
                if (!eventsMap.has(reg.event.id)) {
                    eventsMap.set(reg.event.id, {
                        event: reg.event,
                        attendees: []
                    });
                }
                eventsMap.get(reg.event.id).attendees.push(reg);
            });

            // Create cards for each event with its attendees
            // Create cards for each event with its attendees
            eventsMap.forEach((eventData, eventId) => {
                const eventCard = document.createElement('div');
                eventCard.className = 'card event-registration-card mb-4';

                // Calcola i partecipanti totali
                const totaleIscritti = eventData.attendees.reduce((sum, a) => sum + (a.partecipanti || 1), 0);

                // Event header
                const header = document.createElement('div');
                header.className = 'event-registration-header';
                header.innerHTML = `
        <div class="d-flex justify-content-between">
            <h5>${escape(eventData.event.titolo)}</h5>
            <span class="badge ${eventData.event.postiTotali && totaleIscritti >= eventData.event.postiTotali ? 'bg-danger' : 'bg-success'}">
                ${eventData.event.postiTotali
                    ? `${totaleIscritti}/${eventData.event.postiTotali} iscritti`
                    : `${totaleIscritti} iscritti`}
            </span>
        </div>
        <div class="text-muted small">
            ${formatDateTime(eventData.event.data)} |
            ${eventData.event.postiTotali !== null
                    ? `${eventData.event.postiTotali - totaleIscritti} posti disponibili`
                    : 'Posti illimitati'}
        </div>
    `;

                // Attendees table
                const tableDiv = document.createElement('div');
                tableDiv.className = 'table-responsive';

                if (eventData.attendees.length === 0) {
                    tableDiv.innerHTML = `
            <div class="alert alert-warning m-3">
                Nessun iscritto a questo evento
            </div>
        `;
                } else {
                    const rows = eventData.attendees.map(attendee => `
    <tr>
        <td>${escape(attendee.user.name)}</td>
        <td>${escape(attendee.user.phone)}</td>
        <td>${formatDateTime(attendee.createdAt)}</td>
        <td>${attendee.partecipanti || 1}</td>
        <td>${escape(attendee.note || '-')}</td>
        <td>
            <input type="text" id="event-table-${attendee.id}"
                   class="form-control form-control-sm"
                   value="${attendee.tableNumber || ''}"
                   placeholder="Tavolo" />
        </td>
        <td class="text-nowrap">
            <button class="btn btn-sm btn-success" onclick="updateEventTable(${attendee.id})">
                <i class="fas fa-check"></i>
            </button>
            <button class="btn btn-sm btn-danger"
                    onclick="unregisterFromEvent(${eventId}, ${attendee.user.id})">
                <i class="fas fa-user-times"></i> Rimuovi
            </button>
        </td>
    </tr>
`).join('');


                    tableDiv.innerHTML = `
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Telefono</th>
                        <th>Data Registrazione</th>
                        <th>Persone</th>
                        <th>Note</th>
                        <th>Tavolo</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
                }

                eventCard.appendChild(header);
                eventCard.appendChild(tableDiv);
                container.appendChild(eventCard);
            });

        } catch (error) {
            console.error('Error loading event registrations:', error);
            document.getElementById('eventsRegistrationsContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle"></i> Errore nel caricamento delle registrazioni
            </div>
        `;
        }
    }

    // Gestione form prenotazione tavolo
    document.getElementById('formTableBooking').addEventListener('submit', async function(e) {
        e.preventDefault();

        const payload = {
            name: document.getElementById('tableBookingName').value,
            phone: document.getElementById('tableBookingPhone').value,
            note: document.getElementById('tableBookingNote').value || null,
            date: document.getElementById('tableBookingDate').value,
            time: document.getElementById('tableBookingTime').value,
            people: parseInt(document.getElementById('tableBookingPeople').value)
        };

        try {
            const res = await fetch('/admin/reservations', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('Prenotazione salvata!');
                this.reset();
                document.getElementById('tableBookingDate').value = new Date().toISOString().split('T')[0];
                loadTableBookings();
            } else {
                const error = await res.json();
                alert(error.message || 'Errore durante il salvataggio');
            }
        } catch (error) {
            console.error('Error saving table booking:', error);
            alert('Errore durante il salvataggio');
        }
    });

    // Gestione form registrazione evento
    document.getElementById('formEventRegistration').addEventListener('submit', async function(e) {
        e.preventDefault();

        const eventId = document.getElementById('eventRegEvent').value;
        if (!eventId) {
            alert('Seleziona un evento');
            return;
        }

        const payload = {
            name: document.getElementById('eventRegName').value,
            phone: document.getElementById('eventRegPhone').value,
            note: document.getElementById('eventRegNote').value || null,
            partecipanti: parseInt(document.getElementById('eventRegPeople').value)
        };


        try {
            const res = await fetch(`/admin/events/${eventId}/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert('Registrazione salvata!');
                this.reset();
                loadEventRegistrations();
                loadEventsForRegistration(); // Ricarica disponibilità posti
            } else {
                const error = await res.json();
                alert(error.message || 'Errore durante il salvataggio');
            }
        } catch (error) {
            console.error('Error saving event registration:', error);
            alert('Errore durante il salvataggio');
        }
    });

    // Elimina prenotazione tavolo
    async function deleteTableBooking(id) {
        console.log("ID prenotazione da eliminare:", id); // <-- DEBUG
        if (!confirm('Eliminare questa prenotazione?')) return;

        try {
            await fetch(`/admin/reservations/${id}`, { method: 'DELETE' });
            loadTableBookings();
        } catch (error) {
            console.error('Error deleting booking:', error);
            alert('Errore durante l\'eliminazione');
        }
    }

    // Disiscrivi da evento
    async function unregisterFromEvent(eventId, userId) {
        if (!confirm('Rimuovere questo partecipante?')) return;

        try {
            await fetch(`/admin/events/${eventId}/unregister/${userId}`, { method: 'DELETE' });
            loadEventRegistrations();
            loadEventsForRegistration(); // Ricarica disponibilità posti
        } catch (error) {
            console.error('Error unregistering:', error);
            alert('Errore durante la rimozione');
        }
    }

    // Mostra la tab selezionata
    $('#bookingTabs a').on('click', function(e) {
        e.preventDefault();
        $(this).tab('show');

        if (this.getAttribute('href') === '#eventRegistrations') {
            loadEventRegistrations();
        } else {
            loadTableBookings();
        }
    });
    async function updateTable(id) {
        const tableInput = document.getElementById(`table-${id}`);
        const tableNumber = tableInput.value;

        try {
            const res = await fetch(`/admin/reservations/${id}/table`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tableNumber })
            });

            if (res.ok) {
                alert("✅ Tavolo aggiornato!");
                loadTableBookings();
            } else {
                const error = await res.json();
                alert("❌ Errore: " + (error.message || 'Impossibile aggiornare il tavolo'));
            }
        } catch (error) {
            console.error("Error updating table:", error);
            alert("❌ Errore durante l'aggiornamento del tavolo");
        }
    }
    async function updateEventTable(id) {
        const tableInput = document.getElementById(`event-table-${id}`);
        const tableNumber = tableInput.value;

        try {
            const res = await fetch(`/admin/events/registrations/${id}/table`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ tableNumber })
            });

            if (res.ok) {
                alert("✅ Tavolo aggiornato!");
                loadEventRegistrations(); // ricarica la lista aggiornata
            } else {
                const error = await res.json();
                alert("❌ Errore: " + (error.message || 'Impossibile aggiornare il tavolo'));
            }
        } catch (error) {
            console.error("Error updating event table:", error);
            alert("❌ Errore durante l'aggiornamento del tavolo");
        }
    }


</script>
</body>
</html>