<!DOCTYPE html>
<html lang="it">
<head>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta charset="UTF-8" />
    <title>Corner – Back Office</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --danger: #f72585;
            --dark: #212529;
            --light: #f8f9fa;
        }

        body {
            padding: 15px;
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .container {
            margin-top: 40px;
            margin-bottom: 60px;
            max-width: 1600px;
        }

        .hidden { display: none; }

        /* Header styles */
        .page-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .page-header h2 {
            font-weight: 700;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Section switcher */
        .section-switcher {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .section-btn {
            flex: 1;
            min-width: 160px;
            max-width: 220px;
            padding: 12px 15px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .section-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* Card styles */
        .card-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 25px;
            margin-bottom: 30px;
        }

        .card-section h4 {
            color: var(--primary);
            border-bottom: 2px solid #e9ecef;
            padding-bottom: 15px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Tables */
        .custom-table {
            border-collapse: separate;
            border-spacing: 0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0,0,0,0.03);
        }

        .custom-table th {
            background-color: #f1f5fd;
            color: var(--primary);
            font-weight: 600;
        }

        .custom-table th,
        .custom-table td {
            vertical-align: middle;
            padding: 15px;
            border-top: 1px solid #e9ecef;
        }

        .custom-table tr:last-child td {
            border-bottom: 1px solid #e9ecef;
        }

        /* Images */
        img.thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0,0,0,0.1);
        }

        /* Forms */
        .form-card {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            border: 1px solid #e2e8f0;
        }

        /* Buttons */
        .btn-action {
            padding: 8px 15px;
            border-radius: 6px;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }

        /* Promotions */
        .promo-card {
            background: #fff9f9;
            border-left: 4px solid var(--danger);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .section-btn {
                min-width: 140px;
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .page-header {
                padding: 20px;
            }

            .page-header h2 {
                font-size: 1.5rem;
            }

            .card-section {
                padding: 20px 15px;
            }

            .custom-table th,
            .custom-table td {
                padding: 10px;
                font-size: 0.9rem;
            }

            .form-card {
                padding: 15px;
            }
        }
        /* Eventi styles */
        .event-status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .event-status-available {
            background-color: #d4edda;
            color: #155724;
        }

        .event-status-full {
            background-color: #f8d7da;
            color: #721c24;
        }

        .event-status-unlimited {
            background-color: #e2e3e5;
            color: #383d41;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="page-header">
        <h2><i class="fas fa-cogs"></i> Back Office – Corner</h2>
    </div>

    <!-- Section Switcher -->
    <div class="section-switcher">
        <button class="btn btn-primary section-btn" onclick="showSection('prenotazioni')">
            <i class="fas fa-calendar-alt"></i> Prenotazioni
        </button>
        <button class="btn btn-info section-btn" onclick="showSection('menu')">
            <i class="fas fa-utensils"></i> Menu
        </button>
        <button class="btn btn-warning section-btn" onclick="showSection('evidenza')">
            <i class="fas fa-star"></i> In Evidenza
        </button>
        <button class="btn btn-danger section-btn" onclick="showSection('promozioni')">
            <i class="fas fa-tag"></i> Promozioni
        </button>
        <button class="btn btn-dark section-btn" onclick="showSection('utenti')">
            <i class="fas fa-users"></i> Utenti
        </button>
        <!-- Nella sezione dei pulsanti di navigazione, aggiungi questo nuovo pulsante -->
        <button class="btn btn-success section-btn" onclick="showSection('eventi')">
            <i class="fas fa-calendar-check"></i> Eventi
        </button>
    </div>

    <!-- Prenotazioni Section -->
    <div id="sectionPrenotazioni" class="card-section">
        <h4><i class="fas fa-calendar-alt"></i> Gestione Prenotazioni</h4>
        <div id="reservationsByDateContainer"></div>
    </div>

    <!-- Menu Section -->
    <div id="sectionMenu" class="card-section hidden">
        <h4><i class="fas fa-utensils"></i> Gestione Menu</h4>

        <!-- Add New Item -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Aggiungi nuovo piatto</h5>
            <form id="formAddNewItem">
                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label>Titolo</label>
                        <input type="text" name="titolo" class="form-control" placeholder="Nome del piatto" required />
                    </div>
                    <div class="form-group col-md-2">
                        <label>Categoria</label>
                        <select name="categoria" class="form-control" id="categoriaSelectMenu" required>
                            <option value="">Seleziona Categoria</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3">
                        <label>Descrizione</label>
                        <input type="text" name="descrizione" class="form-control" placeholder="Descrizione" />
                    </div>
                    <div class="form-group col-md-2">
                        <label>Prezzo (€)</label>
                        <input type="number" step="0.01" name="prezzo" class="form-control" placeholder="0.00" required />
                    </div>
                    <div class="form-group col-md-2">
                        <label>Immagine</label>
                        <input type="file" name="image" accept="image/*" class="form-control-file" required />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-2">
                        <label>Visibile</label>
                        <select name="visibile" class="form-control">
                            <option value="true">✅ Sì</option>
                            <option value="false">❌ No</option>
                        </select>
                    </div>
                    <div class="form-group col-md-3 mt-4 pt-2">
                        <button type="submit" class="btn btn-success btn-action">
                            <i class="fas fa-save"></i> Salva Piatto
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Menu List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Menu Attuale</h5>
            <div id="menuTablesContainer"></div>
        </div>
    </div>

    <!-- Evidenza Section -->
    <div id="sectionEvidenza" class="card-section hidden">
        <h4><i class="fas fa-star"></i> Contenuti in Evidenza</h4>

        <!-- Add Highlight -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Aggiungi Contenuto</h5>
            <form id="formAddHighlight">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Categoria</label>
                        <select id="categoriaSelectEvidenza" class="form-control" required>
                            <option value="">Seleziona Categoria</option>
                        </select>
                    </div>
                    <div class="form-group col-md-4">
                        <label>Prodotto</label>
                        <select id="prodottoSelectEvidenza" class="form-control" disabled required>
                            <option value="">Seleziona Prodotto</option>
                        </select>
                    </div>
                    <div class="form-group col-md-2 mt-4 pt-2">
                        <button type="submit" class="btn btn-warning btn-action">
                            <i class="fas fa-plus"></i> Aggiungi
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Highlights List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Contenuti Attivi</h5>
            <div id="highlightsContainer" class="mt-3"></div>
        </div>
    </div>

    <!-- Promozioni Section -->
    <div id="sectionPromozioni" class="card-section hidden">
        <h4><i class="fas fa-tag"></i> Gestione Promozioni</h4>

        <!-- Add Promotion -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Crea Nuova Promozione</h5>
            <form id="formAddPromozione">
                <div class="form-row">
                    <div class="form-group col-md-6">
                        <label>Nome Promozione</label>
                        <input type="text" class="form-control" name="nome" placeholder="Nome della promozione" required>
                    </div>
                    <div class="form-group col-md-6">
                        <label>Sconto (%)</label>
                        <input type="number" step="1" min="1" max="100" name="sconto" class="form-control" placeholder="%" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label>Descrizione</label>
                        <textarea name="descrizione" class="form-control" placeholder="Descrizione promozione" rows="2"></textarea>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group col-md-3">
                        <label>Data Inizio</label>
                        <input type="date" name="dataInizio" class="form-control" required />
                    </div>
                    <div class="form-group col-md-3">
                        <label>Data Fine</label>
                        <input type="date" name="dataFine" class="form-control" required />
                    </div>
                </div>

                <div class="form-row mt-3">
                    <div class="form-group col-md-12">
                        <label><i class="fas fa-list"></i> Prodotti inclusi</label>
                        <div id="checklistProdottiPromozione" class="row mt-2"></div>
                    </div>
                </div>

                <div class="form-row mt-3">
                    <div class="col-md-12">
                        <div class="alert alert-info" id="selectedPromoSummary" style="display: none;"></div>
                    </div>
                </div>

                <div class="form-row mt-3">
                    <div class="col-md-12">
                        <button type="submit" class="btn btn-danger btn-action">
                            <i class="fas fa-fire"></i> Crea Promozione
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Promotions List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Promozioni Attive</h5>
            <div class="table-responsive">
                <table class="table custom-table">
                    <thead class="thead-light">
                    <tr>
                        <th>Nome</th>
                        <th>Descrizione</th>
                        <th>Periodo</th>
                        <th>Sconto</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                    </thead>
                    <tbody id="promozioniTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Utenti Section -->
    <div id="sectionUtenti" class="card-section hidden">
        <h4><i class="fas fa-users"></i> Gestione Utenti</h4>

        <div class="table-responsive">
            <table class="table custom-table">
                <thead class="thead-light">
                <tr>
                    <th>ID</th>
                    <th>Nome</th>
                    <th>Telefono</th>
                    <th>Email</th>
                    <th>Registrazione</th>
                    <th>Azioni</th>
                </tr>
                </thead>
                <tbody id="utentiTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Eventi Section -->
    <div id="sectionEventi" class="card-section hidden">
        <h4><i class="fas fa-calendar-check"></i> Gestione Eventi</h4>

        <!-- Add New Event -->
        <div class="form-card mb-5">
            <h5 class="mb-3"><i class="fas fa-plus-circle"></i> Crea Nuovo Evento</h5>
            <form id="formAddEvento">
                <div class="form-row">
                    <div class="form-group col-md-4">
                        <label>Titolo</label>
                        <input type="text" name="titolo" class="form-control" placeholder="Titolo evento" required />
                    </div>
                    <div class="form-group col-md-4">
                        <label>Data e Ora</label>
                        <input type="datetime-local" name="data" class="form-control" required />
                    </div>
                    <div class="form-group col-md-4">
                        <label>Posti Totali (lasciare vuoto per illimitati)</label>
                        <input type="number" name="postiTotali" class="form-control" placeholder="Numero posti" min="1" />
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group col-md-12">
                        <label>Descrizione</label>
                        <textarea name="descrizione" class="form-control" placeholder="Descrizione evento" rows="3"></textarea>
                    </div>
                </div>
                <div class="form-row mt-3">
                    <div class="form-group col-md-12">
                        <button type="submit" class="btn btn-success btn-action">
                            <i class="fas fa-save"></i> Crea Evento
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- Events List -->
        <div class="mt-4">
            <h5 class="mb-3"><i class="fas fa-list"></i> Eventi Programmati</h5>
            <div class="table-responsive">
                <table class="table custom-table">
                    <thead class="thead-light">
                    <tr>
                        <th>Titolo</th>
                        <th>Descrizione</th>
                        <th>Data</th>
                        <th>Posti</th>
                        <th>Azioni</th>
                    </tr>
                    </thead>
                    <tbody id="eventiTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Iscritti Modal -->
        <div class="modal fade" id="iscrittiModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Iscritti all'evento</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefono</th>
                                    <th>Email</th>
                                    <th>Data Iscrizione</th>
                                </tr>
                                </thead>
                                <tbody id="iscrittiModalBody"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Chiudi</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Utility functions
    function capitalize(str) {
        return str.charAt(0).toUpperCase() + str.slice(1);
    }

    function escape(str) {
        if (!str) return '';
        return str.replace(/\\/g, '\\\\').replace(/`/g, '\\`').replace(/"/g, '&quot;').replace(/'/g, '&#039;');
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleDateString('it-IT', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    function formatDateTime(dateStr) {
        if (!dateStr) return '';
        const d = new Date(dateStr);
        return d.toLocaleString('it-IT');
    }

    // Section management
    function showSection(section) {
        ['prenotazioni', 'menu', 'evidenza', 'promozioni', 'utenti', 'eventi'].forEach(s => {
            document.getElementById('section' + capitalize(s)).classList.add('hidden');
        });
        document.getElementById('section' + capitalize(section)).classList.remove('hidden');

        if (section === 'prenotazioni') {
            loadReservations();
        } else if (section === 'menu') {
            loadMenuItems();
        } else if (section === 'evidenza') {
            loadInEvidenza();
        } else if (section === 'promozioni') {
            loadPromozioni();
        } else if (section === 'utenti') {
            loadUtenti();
        } else if (section === 'eventi') {
            loadEventi();
        }
    }

    // Prenotazioni functions
    async function loadReservations() {
        try {
            const res = await fetch('/admin/reservations');
            const data = await res.json();
            const grouped = {};
            data.forEach(r => {
                if (!grouped[r.date]) grouped[r.date] = [];
                grouped[r.date].push(r);
            });

            const container = document.getElementById('reservationsByDateContainer');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h4>Nessuna prenotazione trovata</h4>
                        <p>Non ci sono prenotazioni registrate al momento</p>
                    </div>
                `;
                return;
            }

            Object.keys(grouped).sort().forEach(date => {
                const section = document.createElement('div');
                section.classList.add('mb-5');

                const rows = grouped[date].map(r => `
                    <tr>
                        <td>${r.name}</td>
                        <td>${r.phone}</td>
                        <td>${r.time}</td>
                        <td>${r.people}</td>
                        <td>${r.note || '-'}</td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-danger btn-action" onclick="deleteReservation(${r.id})">
                                <i class="fas fa-trash-alt"></i> Elimina
                            </button>
                        </td>
                    </tr>
                `).join('');

                section.innerHTML = `
                    <h5 class="d-flex align-items-center">
                        <i class="fas fa-calendar-day me-2"></i> ${formatDate(date)}
                    </h5>
                    <div class="table-responsive">
                        <table class="table custom-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Nome</th>
                                    <th>Telefono</th>
                                    <th>Ora</th>
                                    <th>Persone</th>
                                    <th>Note</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
                container.appendChild(section);
            });
        } catch (error) {
            console.error('Error loading reservations:', error);
            document.getElementById('reservationsByDateContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Errore durante il caricamento delle prenotazioni
                </div>
            `;
        }
    }

    async function deleteReservation(id) {
        if (!confirm('Vuoi davvero eliminare questa prenotazione?')) return;
        try {
            const res = await fetch(`/admin/reservations/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadReservations();
            } else {
                alert('Errore durante l\'eliminazione.');
            }
        } catch (error) {
            console.error('Error deleting reservation:', error);
            alert('Errore durante l\'eliminazione.');
        }
    }

    // Menu functions
    function populateSelect(context, categories) {
        const select = document.getElementById(`categoriaSelect${context}`);
        select.innerHTML = '<option value="">Seleziona Categoria</option>';
        categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            select.appendChild(opt);
        });
    }

    async function loadMenuItems() {
        try {
            const res = await fetch('/admin/menu');
            const data = await res.json();
            const grouped = {};
            data.forEach(item => {
                if (!grouped[item.categoria]) grouped[item.categoria] = [];
                grouped[item.categoria].push(item);
            });

            populateSelect('Menu', Object.keys(grouped));
            const container = document.getElementById('menuTablesContainer');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle fa-2x mb-3"></i>
                        <h4>Menu vuoto</h4>
                        <p>Non ci sono piatti nel menu al momento</p>
                    </div>
                `;
                return;
            }

            Object.keys(grouped).sort().forEach(cat => {
                const section = document.createElement('div');
                section.classList.add('mb-5');

                const rows = grouped[cat].map(item => {
                    const imgSrc = item.imageUrl && item.imageUrl.trim() !== '' ?
                        item.imageUrl : `https://res.cloudinary.com/dytvizqtq/image/upload/prodotti/${item.id}.png`;

                    return `
                        <tr id="menu-row-${item.id}">
                            <td><img src="${imgSrc}" onerror="this.onerror=null;this.src='/img/placeholder.png'" class="thumb" /></td>
                            <td>${escape(item.titolo)}</td>
                            <td>${escape(item.descrizione || '-')}</td>
                            <td>€${item.prezzo.toFixed(2)}</td>
                            <td>
                                <button class="status-badge btn btn-sm ${item.visibile ? 'bg-success' : 'bg-secondary'}"
                                        onclick="toggleVisibility(${item.id})"
                                        title="Clicca per cambiare stato">
                                    ${item.visibile ? 'Visibile' : 'Nascosto'}
                                </button>
                            </td>
                            <td class="text-nowrap">
                                <button class="btn btn-sm btn-warning btn-action" onclick="makeEditable(${item.id}, '${escape(item.titolo)}', '${escape(item.categoria)}', '${escape(item.descrizione || '')}', ${item.prezzo})">
                                    <i class="fas fa-edit"></i> Modifica
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" onclick="deleteMenuItem(${item.id})">
                                    <i class="fas fa-trash-alt"></i> Elimina
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

                section.innerHTML = `
                    <h5 class="d-flex align-items-center">
                        <i class="fas fa-utensils me-2"></i> ${escape(cat)}
                    </h5>
                    <div class="table-responsive">
                        <table class="table custom-table">
                            <thead class="thead-light">
                                <tr>
                                    <th>Foto</th>
                                    <th>Titolo</th>
                                    <th>Descrizione</th>
                                    <th>Prezzo</th>
                                    <th>Stato</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </div>
                `;
                container.appendChild(section);
            });
        } catch (error) {
            console.error('Error loading menu items:', error);
            document.getElementById('menuTablesContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Errore durante il caricamento del menu
                </div>
            `;
        }
    }

    document.getElementById('formAddNewItem').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const data = {
            titolo: form.titolo.value,
            categoria: form.categoria.value,
            descrizione: form.descrizione.value,
            prezzo: parseFloat(form.prezzo.value),
            visibile: form.visibile.value === 'true'
        };

        const formData = new FormData();
        formData.append('data', new Blob([JSON.stringify(data)], { type: 'application/json' }));
        if (form.image.files[0]) formData.append('image', form.image.files[0]);

        try {
            const res = await fetch('/admin/menu', { method: 'POST', body: formData });
            if (res.ok) {
                alert('✅ Piatto aggiunto con successo!');
                form.reset();
                loadMenuItems();
            } else {
                alert('❌ Errore durante l\'aggiunta del piatto');
            }
        } catch (error) {
            console.error('Error adding menu item:', error);
            alert('❌ Errore durante l\'aggiunta del piatto');
        }
    });

    async function toggleVisibility(id) {
        try {
            await fetch(`/admin/menu/${id}/toggle`, { method: 'PATCH' });
            loadMenuItems();
        } catch (error) {
            console.error('Error toggling visibility:', error);
            alert('Errore durante l\'aggiornamento dello stato');
        }
    }

    async function deleteMenuItem(id) {
        if (!confirm('Sei sicuro di voler eliminare questo piatto?')) return;
        try {
            await fetch(`/admin/menu/${id}`, { method: 'DELETE' });
            loadMenuItems();
        } catch (error) {
            console.error('Error deleting menu item:', error);
            alert('Errore durante l\'eliminazione del piatto');
        }
    }

    function makeEditable(id, titolo, categoria, descrizione, prezzo) {
        const row = document.getElementById(`menu-row-${id}`);
        row.innerHTML = `
            <td><input type="file" id="edit-image-${id}" accept="image/*" class="form-control-file" /></td>
            <td><input type="text" id="edit-titolo-${id}" value="${titolo}" class="form-control" /></td>
            <td><input type="text" id="edit-desc-${id}" value="${descrizione}" class="form-control" /></td>
            <td><input type="number" id="edit-prezzo-${id}" value="${prezzo}" step="0.01" class="form-control" /></td>
            <td><input type="text" id="edit-cat-${id}" value="${categoria}" class="form-control" /></td>
            <td class="text-nowrap">
                <button class="btn btn-sm btn-success btn-action" onclick="submitEdit(${id})">
                    <i class="fas fa-check"></i> Salva
                </button>
                <button class="btn btn-sm btn-secondary btn-action" onclick="loadMenuItems()">
                    <i class="fas fa-times"></i> Annulla
                </button>
            </td>
        `;
    }

    async function submitEdit(id) {
        const titolo = document.getElementById(`edit-titolo-${id}`).value;
        const descrizione = document.getElementById(`edit-desc-${id}`).value;
        const prezzo = parseFloat(document.getElementById(`edit-prezzo-${id}`).value);
        const categoria = document.getElementById(`edit-cat-${id}`).value;
        const imageInput = document.getElementById(`edit-image-${id}`);

        const data = { titolo, descrizione, prezzo, categoria };
        const formData = new FormData();
        formData.append('data', new Blob([JSON.stringify(data)], { type: 'application/json' }));
        if (imageInput.files.length > 0) formData.append('image', imageInput.files[0]);

        try {
            await fetch(`/admin/menu/${id}`, { method: 'PUT', body: formData });
            loadMenuItems();
        } catch (error) {
            console.error('Error updating menu item:', error);
            alert('Errore durante l\'aggiornamento del piatto');
        }
    }

    // Evidenza functions
    async function loadInEvidenza() {
        try {
            const [menuRes, evidenzaRes] = await Promise.all([
                fetch('/admin/menu'),
                fetch('/admin/in_evidenza')
            ]);

            const menuData = await menuRes.json();
            const evidenzaData = await evidenzaRes.json();

            const idToTitolo = {};
            menuData.forEach(item => {
                idToTitolo[item.id] = item.titolo;
            });

            const categories = [...new Set(menuData.map(i => i.categoria))].sort();
            populateSelect('Evidenza', categories);

            const container = document.getElementById('highlightsContainer');
            container.innerHTML = '';

            if (evidenzaData.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i> Nessun contenuto in evidenza al momento
                    </div>
                `;
                return;
            }

            evidenzaData.forEach(h => {
                const itemId = h.itemId || h.item_id;
                const titolo = idToTitolo[itemId] || 'Titolo non disponibile';

                const div = document.createElement('div');
                div.classList.add('d-flex', 'justify-content-between', 'align-items-center', 'border-bottom', 'pb-2', 'mb-3');
                div.innerHTML = `
                    <div>
                        <span class="badge bg-primary me-2">${h.categoria}</span>
                        <strong>${titolo}</strong>
                    </div>
                    <button class="btn btn-sm btn-danger btn-action" onclick="deleteInEvidenza(${h.id})">
                        <i class="fas fa-times"></i> Rimuovi
                    </button>
                `;
                container.appendChild(div);
            });
        } catch (error) {
            console.error('Error loading highlights:', error);
            document.getElementById('highlightsContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle"></i> Errore durante il caricamento dei contenuti in evidenza
                </div>
            `;
        }
    }

    document.getElementById('categoriaSelectEvidenza').addEventListener('change', async e => {
        const cat = e.target.value;
        const prodSelect = document.getElementById('prodottoSelectEvidenza');
        prodSelect.innerHTML = '<option value="">Seleziona Prodotto</option>';

        if (!cat) {
            prodSelect.disabled = true;
            return;
        }

        try {
            const res = await fetch('/admin/menu');
            const items = (await res.json()).filter(i => i.categoria === cat);

            items.forEach(i => {
                const opt = document.createElement('option');
                opt.value = i.id;
                opt.textContent = i.titolo;
                prodSelect.appendChild(opt);
            });

            prodSelect.disabled = false;
        } catch (error) {
            console.error('Error loading products:', error);
        }
    });

    document.getElementById('formAddHighlight').addEventListener('submit', async e => {
        e.preventDefault();
        const cat = document.getElementById('categoriaSelectEvidenza').value;
        const prodId = document.getElementById('prodottoSelectEvidenza').value;

        if (!cat || !prodId) {
            alert('Seleziona sia la categoria che il prodotto');
            return;
        }

        try {
            const res = await fetch('/admin/in_evidenza', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ categoria: cat, itemId: prodId })
            });

            if (res.ok) {
                loadInEvidenza();
                e.target.reset();
                document.getElementById('prodottoSelectEvidenza').disabled = true;
            } else {
                alert('Errore durante l\'aggiunta del contenuto in evidenza');
            }
        } catch (error) {
            console.error('Error adding highlight:', error);
            alert('Errore durante l\'aggiunta del contenuto in evidenza');
        }
    });

    async function deleteInEvidenza(id) {
        if (!confirm('Sei sicuro di voler rimuovere questo contenuto in evidenza?')) return;

        try {
            const res = await fetch(`/admin/in_evidenza/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadInEvidenza();
            } else {
                alert('Errore durante la rimozione');
            }
        } catch (error) {
            console.error('Error deleting highlight:', error);
            alert('Errore durante la rimozione');
        }
    }

    // Promozioni functions
    async function loadPromozioni() {
        try {
            const [menuRes, promoRes] = await Promise.all([
                fetch('/admin/menu'),
                fetch('/admin/promotions')
            ]);

            const menuData = await menuRes.json();
            const promoData = await promoRes.json();

            // Checklist for new promotion
            const grouped = {};
            menuData.forEach(item => {
                if (!grouped[item.categoria]) grouped[item.categoria] = [];
                grouped[item.categoria].push(item);
            });

            const checklist = document.getElementById('checklistProdottiPromozione');
            checklist.innerHTML = '';

            Object.keys(grouped).sort().forEach(categoria => {
                const section = document.createElement('div');
                section.classList.add('col-md-6', 'mb-4');

                const items = grouped[categoria].map(item => `
                    <div class="form-check mb-2">
                        <input class="form-check-input promo-checkbox" type="checkbox" value="${item.id}" id="prod-${item.id}" data-title="${item.titolo}">
                        <label class="form-check-label" for="prod-${item.id}">
                            ${item.titolo} <span class="text-muted">(€${item.prezzo.toFixed(2)})</span>
                        </label>
                    </div>
                `).join('');

                section.innerHTML = `
                    <div class="card h-100">
                        <div class="card-header bg-light">
                            <strong>${categoria}</strong>
                        </div>
                        <div class="card-body">
                            ${items}
                        </div>
                    </div>
                `;
                checklist.appendChild(section);
            });

            // Promotions list
            const promozioniTableBody = document.getElementById('promozioniTableBody');
            promozioniTableBody.innerHTML = '';

            if (promoData.length === 0) {
                promozioniTableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-tag fa-2x mb-3 text-muted"></i>
                            <p class="mb-0">Nessuna promozione attiva</p>
                        </td>
                    </tr>
                `;
                return;
            }

            promoData.sort((a, b) => new Date(a.dataInizio) - new Date(b.dataFine)).forEach(promo => {
                const today = new Date();
                const startDate = new Date(promo.dataInizio);
                const endDate = new Date(promo.dataFine);
                const isActive = today >= startDate && today <= endDate;

                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>
                        <strong>${promo.nome}</strong>
                        <div class="small text-muted">${promo.descrizione || 'Nessuna descrizione'}</div>
                    </td>
                    <td>${promo.descrizione || '-'}</td>
                    <td>
                        ${formatDate(promo.dataInizio)}<br>
                        <span class="text-muted small">al</span><br>
                        ${formatDate(promo.dataFine)}
                    </td>
                    <td class="text-center">
                        <span class="badge bg-danger p-2">${promo.items[0]?.scontoPercentuale || 0}%</span>
                    </td>
                    <td>
                        <span class="status-badge ${isActive ? 'bg-success' : 'bg-secondary'}">
                            ${isActive ? 'Attiva' : 'Scaduta'}
                        </span>
                    </td>
                    <td class="text-nowrap">
                        <button class="btn btn-sm btn-danger btn-action" onclick="eliminaPromozione(${promo.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                promozioniTableBody.appendChild(tr);
            });

            // Add event listeners to checkboxes
            document.querySelectorAll('.promo-checkbox').forEach(cb => {
                cb.addEventListener('change', updatePromoSummary);
            });

        } catch (error) {
            console.error('Error loading promotions:', error);
            document.getElementById('promozioniTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Errore durante il caricamento delle promozioni</p>
                    </td>
                </tr>
            `;
        }
    }

    function updatePromoSummary() {
        const checked = Array.from(document.querySelectorAll('.promo-checkbox:checked'));
        const summary = checked.map(c => c.dataset.title).join(', ');
        const box = document.getElementById('selectedPromoSummary');

        if (checked.length > 0) {
            box.style.display = 'block';
            box.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                <strong>${checked.length} prodotti selezionati:</strong> ${summary}
            `;
        } else {
            box.style.display = 'none';
        }
    }

    document.getElementById('formAddPromozione').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const nome = form.nome.value;
        const sconto = parseFloat(form.sconto.value);
        const descrizione = form.descrizione.value;
        const dataInizio = form.dataInizio.value;
        const dataFine = form.dataFine.value;

        const selectedCheckboxes = Array.from(document.querySelectorAll('.promo-checkbox:checked'));
        if (selectedCheckboxes.length === 0) {
            alert("Seleziona almeno un prodotto!");
            return;
        }

        const items = selectedCheckboxes.map(cb => ({
            menuItemId: parseInt(cb.value),
            scontoPercentuale: sconto
        }));

        const payload = {
            nome,
            descrizione,
            dataInizio,
            dataFine,
            attiva: true,
            items
        };

        try {
            const res = await fetch('/admin/promotions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                alert("✅ Promozione creata con successo!");
                form.reset();
                document.getElementById('selectedPromoSummary').style.display = 'none';
                loadPromozioni();
            } else {
                alert("❌ Errore durante la creazione della promozione");
            }
        } catch (error) {
            console.error('Error creating promotion:', error);
            alert("❌ Errore durante la creazione della promozione");
        }
    });

    async function eliminaPromozione(id) {
        if (!confirm("Sei sicuro di voler eliminare questa promozione?")) return;

        try {
            const res = await fetch(`/admin/promotions/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadPromozioni();
            } else {
                alert("Errore durante l'eliminazione della promozione");
            }
        } catch (error) {
            console.error('Error deleting promotion:', error);
            alert("Errore durante l'eliminazione della promozione");
        }
    }

    // Utenti functions
    async function loadUtenti() {
        try {
            const res = await fetch('/api/users');
            const utenti = await res.json();
            const tbody = document.getElementById('utentiTableBody');
            tbody.innerHTML = '';

            if (utenti.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <i class="fas fa-user-slash fa-2x mb-3 text-muted"></i>
                            <p class="mb-0">Nessun utente registrato</p>
                        </td>
                    </tr>
                `;
                return;
            }

            utenti.forEach(u => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${u.id}</td>
                    <td>${u.name || '-'}</td>
                    <td>${u.phone || '-'}</td>
                    <td>${u.email || '-'}</td>
                    <td>${u.createdAt ? formatDateTime(u.createdAt) : '-'}</td>
                    <td class="text-nowrap">
                        <button class="btn btn-sm btn-danger btn-action" onclick="eliminaUtente(${u.id})">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading users:', error);
            document.getElementById('utentiTableBody').innerHTML = `
                <tr>
                    <td colspan="6" class="text-center py-4 text-danger">
                        <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                        <p>Errore durante il caricamento degli utenti</p>
                    </td>
                </tr>
            `;
        }
    }

    async function eliminaUtente(id) {
        if (!confirm("Sei sicuro di voler eliminare questo utente?")) return;

        try {
            const res = await fetch(`/api/users/${id}`, { method: 'DELETE' });
            if (res.ok) {
                alert("✅ Utente eliminato con successo");
                loadUtenti();
            } else {
                alert("❌ Errore durante l'eliminazione dell'utente");
            }
        } catch (error) {
            console.error('Error deleting user:', error);
            alert("❌ Errore durante l'eliminazione dell'utente");
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        showSection('prenotazioni');
    });

    // Eventi functions
    async function loadEventi() {
        try {
            const res = await fetch('/admin/events');
            const eventi = await res.json();
            const tbody = document.getElementById('eventiTableBody');
            tbody.innerHTML = '';

            if (eventi.length === 0) {
                tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center py-4">
                        <i class="fas fa-calendar-times fa-2x mb-3 text-muted"></i>
                        <p class="mb-0">Nessun evento programmato</p>
                    </td>
                </tr>
            `;
                return;
            }

            eventi.forEach(evento => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                <td><strong>${escape(evento.titolo)}</strong></td>
                <td>${escape(evento.descrizione || '-')}</td>
                <td>${formatDateTime(evento.data)}</td>
                <td>
                    ${evento.postiTotali ?
                    `${evento.postiOccupati}/${evento.postiTotali} (${evento.postiDisponibili} disponibili)` :
                    'Illimitati'}
                </td>
                <td class="text-nowrap">
                    <button class="btn btn-sm btn-info btn-action" onclick="viewIscritti(${evento.id})">
                        <i class="fas fa-users"></i> Iscritti
                    </button>
                    <button class="btn btn-sm btn-danger btn-action" onclick="deleteEvento(${evento.id})">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </td>
            `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            console.error('Error loading events:', error);
            document.getElementById('eventiTableBody').innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4 text-danger">
                    <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                    <p>Errore durante il caricamento degli eventi</p>
                </td>
            </tr>
        `;
        }
    }

    async function viewIscritti(eventId) {
        try {
            const res = await fetch(`/admin/events/${eventId}/attendees`);
            const iscritti = await res.json();

            const modalBody = document.getElementById('iscrittiModalBody');
            modalBody.innerHTML = '';

            if (iscritti.length === 0) {
                modalBody.innerHTML = `
                <tr>
                    <td colspan="4" class="text-center py-4">
                        <i class="fas fa-user-slash fa-2x mb-3 text-muted"></i>
                        <p class="mb-0">Nessun iscritto a questo evento</p>
                    </td>
                </tr>
            `;
            } else {
                iscritti.forEach(iscritto => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                    <td>${escape(iscritto.name || '-')}</td>
                    <td>${escape(iscritto.phone || '-')}</td>
                    <td>${escape(iscritto.email || '-')}</td>
                    <td>${formatDateTime(iscritto.createdAt)}</td>
                `;
                    modalBody.appendChild(tr);
                });
            }

            $('#iscrittiModal').modal('show');
        } catch (error) {
            console.error('Error loading registrations:', error);
            alert('Errore durante il caricamento degli iscritti');
        }
    }

    async function deleteEvento(id) {
        if (!confirm('Sei sicuro di voler eliminare questo evento?')) return;

        try {
            const res = await fetch(`/admin/events/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadEventi();
            } else {
                alert('Errore durante l\'eliminazione dell\'evento');
            }
        } catch (error) {
            console.error('Error deleting event:', error);
            alert('Errore durante l\'eliminazione dell\'evento');
        }
    }

    document.getElementById('formAddEvento').addEventListener('submit', async e => {
        e.preventDefault();
        const form = e.target;
        const data = {
            titolo: form.titolo.value,
            descrizione: form.descrizione.value,
            data: form.data.value,
            postiTotali: form.postiTotali.value ? parseInt(form.postiTotali.value) : null
        };

        try {
            const res = await fetch('/admin/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                alert('✅ Evento creato con successo!');
                form.reset();
                loadEventi();
            } else {
                alert('❌ Errore durante la creazione dell\'evento');
            }
        } catch (error) {
            console.error('Error creating event:', error);
            alert('❌ Errore durante la creazione dell\'evento');
        }
    });
</script>
</body>
</html>